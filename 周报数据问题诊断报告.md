# 周报数据问题诊断报告

## 问题描述
用户反馈：主页能显示今天专注了1小时，但周报显示全是0。

## 问题根源分析

### 1. **数据存储渠道不一致** ⚠️ 关键问题

#### 主页数据来源
- **存储位置**: `localStorage`
- **存储键**: `todayStats`, `weeklyStats`
- **代码位置**: `src/pages/dashboard/index.tsx`
  ```typescript
  const getTodayStats = (): TodayStats => {
    const todayStatsData = localStorage.getItem('todayStats');
    const allTodayStats = todayStatsData ? JSON.parse(todayStatsData) : {};
    return allTodayStats[today] || { minutes: 0, date: today };
  };
  ```

#### 周报数据来源
- **存储位置**: 数据库 `FocusSession` 表
- **查询逻辑**: `src/lib/weeklyReport.ts`
  ```typescript
  db.focusSession.findMany({
    where: { userId, startTime: { gte: weekStart, lte: weekEnd } },
    select: {
      startTime: true,
      duration: true,
      flowIndex: true,
      rating: true,
      expEarned: true,
    },
  })
  ```

### 2. **专注完成后的数据保存逻辑缺失** 🔴 核心问题

**原有逻辑**（`src/pages/focus/index.tsx`）：
- ✅ 专注完成时，数据保存到 `localStorage`
- ❌ **没有调用API保存到数据库的 `FocusSession` 表**

**结果**：
- 主页从 `localStorage` 读取 → ✅ 能显示数据
- 周报从数据库 `FocusSession` 读取 → ❌ 查询结果为空，显示0

## 修复方案

### ✅ 已实施的修复

**1. 在专注完成时添加数据库保存逻辑**

位置：`src/pages/focus/index.tsx` 的 `endSession` 函数

```typescript
// 🔥 保存到数据库（用于周报统计）
if (session?.user?.id && sessionRef.current?.startTime) {
  const startTime = new Date(sessionRef.current.startTime);
  const endTime = new Date(startTime.getTime() + finalElapsedTime * 1000);
  
  console.log('💾 保存专注会话到数据库', {
    userId: session.user.id,
    startTime: startTime.toISOString(),
    endTime: endTime.toISOString(),
    duration: minutes,
    rating: numericRating,
  });
  
  fetch('/api/focus-sessions', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      startTime: startTime.toISOString(),
      endTime: endTime.toISOString(),
      duration: minutes,
      note: sessionName || null,
      rating: numericRating,
      flowIndex: numericRating,
      projectId: selectedGoal || null,
    }),
  }).then(response => {
    if (response.ok) {
      console.log('✅ 专注会话已保存到数据库');
    } else {
      console.error('❌ 保存专注会话失败', response.status);
    }
  }).catch(error => {
    console.error('❌ 保存专注会话网络错误', error);
  });
}
```

**关键改进**：
- ✅ 调用 `/api/focus-sessions` API
- ✅ 传入 `startTime`, `endTime`, `duration` 等完整信息
- ✅ 包含 `projectId`（关联到计划）
- ✅ 异步执行，不阻塞用户体验
- ✅ 添加详细日志便于调试

### 2. 数据库API已就绪

`/api/focus-sessions` API (`src/pages/api/focus-sessions/index.ts`) 已具备完整功能：

✅ **POST 请求**：创建专注记录
- 验证数据合法性
- 使用事务确保数据一致性
- 自动更新 `DailySummary` 表

✅ **GET 请求**：查询专注记录（用于历史查看）

### 3. 周报查询逻辑正确

`src/lib/weeklyReport.ts` 的查询逻辑完整：
- ✅ 按用户ID和时间范围查询
- ✅ 计算每日统计
- ✅ 对比上周数据
- ✅ 查询本周完成的小目标

## 验证步骤

### 测试方法
1. **完成一次新的专注会话**
   - 进入专注页面 `/focus`
   - 设置时长并开始专注
   - 完成后点击"结束"

2. **检查数据库**
   - 打开 Prisma Studio：`npm run db:studio`
   - 查看 `FocusSession` 表
   - 应能看到新增的专注记录，包含：
     - `userId`
     - `startTime`
     - `endTime`
     - `duration`（分钟）
     - `rating`, `flowIndex`

3. **查看周报**
   - 访问 `/reports/weekly`
   - 应能看到本周数据非0
   - 每日专注时长柱状图应有数据

### 预期结果
- ✅ 主页显示专注时长
- ✅ 周报显示专注时长
- ✅ 数据库有完整记录
- ✅ 三者数据一致

## 潜在问题和注意事项

### 1. 历史数据迁移
**问题**：修复前完成的专注会话没有存入数据库

**影响**：
- 主页能看到历史数据（localStorage）
- 周报看不到历史数据（数据库为空）

**解决方案**（可选）：
创建数据迁移脚本，从 localStorage 导入历史数据到数据库：

```typescript
// 迁移脚本示例（需要在服务端运行）
async function migrateLocalStorageToDatabase(userId: string) {
  const todayStatsData = localStorage.getItem('todayStats');
  if (!todayStatsData) return;
  
  const allTodayStats = JSON.parse(todayStatsData);
  
  for (const [date, stats] of Object.entries(allTodayStats)) {
    if (stats.minutes > 0) {
      await db.focusSession.create({
        data: {
          userId,
          startTime: new Date(`${date}T12:00:00Z`),
          endTime: new Date(`${date}T12:00:00Z`),
          duration: stats.minutes,
          note: '历史数据迁移',
        },
      });
    }
  }
}
```

### 2. 时区一致性
**当前状态**：
- 专注记录使用 ISO 时间戳（UTC）
- 周报查询使用本地时区计算周期

**建议**：
- ✅ 保持数据库使用 UTC 时间
- ✅ 前端展示时转换为用户本地时间
- ⚠️ 注意跨时区用户的周期计算

### 3. 离线场景
**问题**：用户离线时完成专注，API调用失败

**当前处理**：
- ✅ 数据仍保存到 localStorage（主页正常）
- ❌ 数据库缺失该记录（周报缺失）

**改进建议**：
- 实现离线队列机制
- 上线后自动重试失败的API请求
- 使用 Service Worker 或 Background Sync API

## 数据流程图

```
用户完成专注
    ↓
endSession()
    ↓
    ├─→ 保存到 localStorage ────→ 主页读取 ✅
    │   (todayStats, weeklyStats)
    │
    └─→ 调用 /api/focus-sessions ─→ 数据库 FocusSession 表
                                        ↓
                                  周报查询 ✅
                                  (computeWeeklyReport)
```

## 总结

### 问题原因
专注完成后只保存到 `localStorage`，没有同步到数据库，导致主页和周报数据来源不一致。

### 解决方案
在专注完成时调用 `/api/focus-sessions` API，将数据同步保存到数据库的 `FocusSession` 表。

### 修复效果
- ✅ 主页和周报数据来源统一
- ✅ 周报能正确显示专注时长
- ✅ 数据库有完整的历史记录
- ✅ 支持跨设备数据同步

---

**修复日期**: 2025-12-24  
**修复文件**: `src/pages/focus/index.tsx`  
**相关API**: `/api/focus-sessions`  
**影响范围**: 专注记录保存、周报统计、历史数据查询

