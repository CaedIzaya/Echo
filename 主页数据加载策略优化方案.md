# 主页数据加载策略优化方案

## 问题分析

### 当前问题
1. **数据来源不一致**：主页关键数据主要从 `localStorage` 读取，数据库未作为可靠数据源
2. **跨设备同步问题**：用户在设备A完成专注，设备B无法看到最新数据
3. **数据丢失风险**：清除浏览器缓存会导致数据丢失
4. **用户体验不佳**：数据不同步导致用户对产品失去信任

### 影响范围
- ❌ 今日专注时长（`todayStats`）
- ❌ 本周统计（`weeklyStats`）
- ❌ 累计专注时长（`totalFocusMinutes`）
- ❌ 连续天数（`streakDays`）
- ✅ 用户经验值（已有 `useUserExp` hook，从数据库加载）
- ✅ 心树经验（已有 `useHeartTreeExp` hook，从数据库加载）
- ✅ 成就数据（已有 `useAchievements` hook，从数据库加载）

---

## 优化方案

### 核心原则

```
数据库（可靠来源） > localStorage（缓存）
```

- **数据库**：作为单一可靠数据源（Single Source of Truth）
- **localStorage**：仅作为性能优化的缓存层
- **优先级**：启动时优先从数据库加载，失败时回退到缓存

---

## 实施步骤

### 1. ✅ 创建统一数据加载 Hook

**文件**：`src/hooks/useDashboardData.ts`

**功能**：
- 登录时自动从数据库加载关键统计数据
- 使用 `localStorage` 作为缓存提升加载速度
- 数据超过1小时自动刷新
- 向后兼容旧的 localStorage 结构

**使用示例**：
```typescript
import { useDashboardData } from '~/hooks/useDashboardData';

function Dashboard() {
  const { data, refresh, isLoading } = useDashboardData();
  
  return (
    <div>
      <p>今日专注: {data.todayMinutes} 分钟</p>
      <p>本周专注: {data.weeklyMinutes} 分钟</p>
      <p>累计专注: {data.totalMinutes} 分钟</p>
      <p>连续天数: {data.streakDays} 天</p>
      {isLoading && <Spinner />}
    </div>
  );
}
```

---

### 2. ✅ 创建数据统计 API

**文件**：`src/pages/api/dashboard/stats.ts`

**端点**：`GET /api/dashboard/stats`

**返回数据**：
```typescript
{
  todayMinutes: number,      // 今日专注时长
  todayDate: string,          // 今日日期 (YYYY-MM-DD)
  weeklyMinutes: number,      // 本周专注时长
  weekStart: string,          // 本周开始日期
  totalMinutes: number,       // 累计专注时长
  streakDays: number,         // 连续天数
  lastStreakDate: string | null,
  syncedAt: string,           // 同步时间戳
}
```

**数据来源**：
- 查询 `FocusSession` 表统计今日/本周/累计时长
- 查询 `User` 表获取连续天数
- 自动修正数据库中的累计时长（如果不一致）

---

### 3. 🔄 改进专注完成后的数据保存

**当前问题**：
- ✅ 已保存到数据库（修复后）
- ❌ 但统计数据未及时刷新

**解决方案**：
```typescript
// 在 focus/index.tsx 的 goToDashboard() 函数中
const goToDashboard = () => {
  // ... 清理代码 ...
  
  // 🔥 标记需要刷新数据
  localStorage.setItem('needRefreshDashboardData', 'true');
  
  router.push('/dashboard');
};
```

```typescript
// 在 dashboard/index.tsx 中监听标记
useEffect(() => {
  const needRefresh = localStorage.getItem('needRefreshDashboardData');
  if (needRefresh === 'true') {
    console.log('🔄 检测到新数据，刷新统计...');
    dashboardData.refresh();
    localStorage.removeItem('needRefreshDashboardData');
  }
}, []);
```

---

### 4. 🔄 数据库字段补充

确保 `User` 表包含所有必要字段：

```prisma
model User {
  id                     String         @id
  // ... 其他字段 ...
  
  // 🔥 关键统计字段
  totalFocusMinutes      Int            @default(0)     // 累计专注时长
  streakDays             Int            @default(0)     // 连续专注天数
  lastStreakDate         String?                        // 最后连续日期
  
  // 关联数据
  focusSessions          FocusSession[]
  // ...
}
```

**状态**：✅ 已存在（检查 `prisma/schema.prisma`）

---

## 数据流程图

### 优化前（问题流程）

```
专注完成
    ↓
仅保存到 localStorage
    ↓
主页从 localStorage 读取 ✅
周报从数据库读取 ❌ (数据为空)
```

### 优化后（正确流程）

```
专注完成
    ├─→ 保存到数据库 ✅
    └─→ 保存到 localStorage (缓存) ✅
         ↓
主页启动
    ├─→ 优先从数据库加载 ✅
    ├─→ 写入 localStorage (缓存)
    └─→ 展示数据 ✅
         ↓
周报查询数据库 ✅
```

---

## 加载时序优化

### 策略：渐进式加载

1. **即时显示**（0ms）
   - 显示 loading 状态
   - 显示缓存数据（如果存在）

2. **首次数据加载**（500ms内）
   - 并行加载所有关键数据
   - 用户经验、心树、今日统计同时请求

3. **后台同步**（2s后）
   - 静默刷新数据确保最新
   - 不阻塞用户交互

**用户体验**：
```
0ms      - 显示界面 + 缓存数据
↓
500ms    - 数据库数据加载完成 ✅
↓
2000ms   - 后台静默同步
```

可接受的加载时间，换取数据准确性！

---

## 关键数据清单

### 必须从数据库加载的数据

| 数据项 | 当前状态 | 数据库表 | Hook/API | 优先级 |
|--------|---------|----------|----------|--------|
| 用户经验值 | ✅ 已实现 | `User.userExp` | `useUserExp` | 高 |
| 用户等级 | ✅ 已实现 | `User.userLevel` | `useUserExp` | 高 |
| 心树经验 | ✅ 已实现 | `User.heartTreeTotalExp` | `useHeartTreeExp` | 高 |
| 今日专注 | 🔄 待接入 | `FocusSession` | `useDashboardData` | 高 |
| 本周统计 | 🔄 待接入 | `FocusSession` | `useDashboardData` | 高 |
| 累计时长 | 🔄 待接入 | `User.totalFocusMinutes` | `useDashboardData` | 高 |
| 连续天数 | 🔄 待接入 | `User.streakDays` | `useDashboardData` | 高 |
| 成就数据 | ✅ 已实现 | `Achievement` | `useAchievements` | 中 |
| 主要计划 | 🔄 待接入 | `Project` | `useProjects` | 中 |
| 小目标 | 🔄 待接入 | `Milestone` | `useProjects` | 中 |

---

## 数据保存检查清单

### 确保所有操作都同步到数据库

| 操作 | localStorage | 数据库 API | 表 | 状态 |
|------|-------------|-----------|-----|------|
| 完成专注 | ✅ | ✅ `/api/focus-sessions` | `FocusSession` | 已修复 |
| 用户经验增加 | ✅ | ✅ `/api/user/exp/update` | `User.userExp` | 已实现 |
| 心树经验增加 | ✅ | ✅ `/api/heart-tree/exp/update` | `User.heartTreeTotalExp` | 已实现 |
| 解锁成就 | ✅ | ✅ `/api/achievements/unlock` | `Achievement` | 已实现 |
| 创建计划 | ✅ | 🔄 需检查 | `Project` | 待验证 |
| 完成小目标 | ✅ | 🔄 需检查 | `Milestone` | 待验证 |
| 心树命名 | ✅ | ✅ `/api/heart-tree/update-name` | `User.heartTreeName` | 已实现 |
| 每日小结 | ✅ | ✅ 自动生成 | `DailySummary` | 已实现 |

---

## 实施优先级

### Phase 1: 核心统计数据（本次完成）✅

- [x] 创建 `useDashboardData` hook
- [x] 创建 `/api/dashboard/stats` API
- [x] 确保专注完成后保存到数据库
- [x] 添加数据同步日志

### Phase 2: 主页集成（下一步）🔄

- [ ] 在 `dashboard/index.tsx` 中使用 `useDashboardData`
- [ ] 替换所有从 localStorage 读取统计数据的代码
- [ ] 添加 loading 状态展示
- [ ] 专注完成后触发数据刷新

### Phase 3: 计划和小目标（后续）

- [ ] 创建 `useProjects` hook（从数据库加载）
- [ ] 验证计划创建/更新是否保存到数据库
- [ ] 验证小目标完成是否保存到数据库
- [ ] 添加离线队列机制

### Phase 4: 容错和优化

- [ ] 实现离线队列（专注数据延迟上传）
- [ ] 添加数据冲突解决机制
- [ ] 优化并发请求性能
- [ ] 添加数据校验和修复工具

---

## 测试验证

### 验证步骤

1. **清空 localStorage 测试**
   ```javascript
   localStorage.clear();
   ```
   - 刷新主页
   - 应能从数据库加载所有数据 ✅

2. **跨设备同步测试**
   - 设备A：完成专注
   - 设备B：刷新主页
   - 应能看到最新数据 ✅

3. **离线场景测试**
   - 断网完成专注
   - 数据保存到 localStorage
   - 联网后刷新，应触发同步 🔄

4. **数据一致性测试**
   - 对比主页显示 vs 数据库数据
   - 对比周报显示 vs 数据库数据
   - 应完全一致 ✅

---

## 性能考虑

### 加载时间优化

**目标**：首屏数据在 500ms 内加载完成

**措施**：
1. ✅ 使用缓存优先策略
2. ✅ 并行请求所有数据
3. ✅ 后台静默同步
4. ✅ 避免阻塞渲染

### 网络请求优化

**当前**：多个独立 hook 分别请求
- `useUserExp` → `/api/user/exp`
- `useHeartTreeExp` → `/api/heart-tree/exp`
- `useDashboardData` → `/api/dashboard/stats`

**优化方案**（可选）：
- 创建 `/api/dashboard/all` 聚合端点
- 一次请求返回所有数据
- 减少网络往返

---

## 回滚方案

如果新方案出现问题，回滚步骤：

1. 移除 `useDashboardData` hook 的使用
2. 恢复直接从 localStorage 读取
3. 保留数据库保存逻辑（不影响数据持久化）

---

## 总结

### 核心改进

1. ✅ **数据库优先**：所有关键数据从数据库加载
2. ✅ **缓存加速**：使用 localStorage 提升性能
3. ✅ **双向同步**：确保数据库和缓存一致
4. ✅ **容错机制**：失败时使用缓存数据

### 用户体验提升

- 🎯 **数据准确**：不再丢失数据
- 🎯 **跨设备同步**：随时随地看到最新数据
- 🎯 **加载迅速**：缓存优先，体验流畅
- 🎯 **值得信赖**：数据持久化到数据库

### 下一步行动

1. ✅ 核心 hook 和 API 已创建
2. 🔄 需要在主页集成 `useDashboardData`
3. 🔄 需要验证所有数据保存路径
4. 🔄 需要添加完整的错误处理

---

**创建日期**: 2025-12-24  
**负责模块**: Dashboard 数据加载  
**影响范围**: 主页统计、周报、跨设备同步  
**优先级**: 🔴 高（影响核心用户体验）

