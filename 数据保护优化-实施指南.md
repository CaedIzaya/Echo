# ğŸ”’ æ•°æ®ä¿æŠ¤ä¼˜åŒ– - å®æ–½æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ¬¡ä¼˜åŒ–å°†**è¿ç»­å¤©æ•°**å’Œ**æ€»ä¸“æ³¨æ—¶é•¿**ä» localStorage ç§»åˆ°æ•°æ®åº“ï¼Œç¡®ä¿ç”¨æˆ·æ•°æ®æ°¸ä¹…å®‰å…¨ã€‚

---

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

### é—®é¢˜
- âŒ è¿ç»­å¤©æ•°ä»…å­˜å‚¨åœ¨ localStorageï¼Œæ¸…é™¤ç¼“å­˜ä¼šä¸¢å¤±
- âŒ æ€»ä¸“æ³¨æ—¶é•¿ä»…å­˜å‚¨åœ¨ localStorageï¼Œä¸åŒè®¾å¤‡ä¸åŒæ­¥
- âŒ æ— æ³•ä»å…¶ä»–æ•°æ®æ¢å¤è¿™ä¸¤é¡¹æ•°æ®

### è§£å†³æ–¹æ¡ˆ
- âœ… å°†æ•°æ®ç§»åˆ°æ•°æ®åº“ï¼ˆUser è¡¨ï¼‰
- âœ… åŒé‡å­˜å‚¨ï¼ˆæ•°æ®åº“ + localStorageï¼‰
- âœ… è‡ªåŠ¨åŒæ­¥æœºåˆ¶
- âœ… æ•°æ®æ¢å¤ä¿æŠ¤

---

## ğŸ—„ï¸ æ•°æ®åº“å˜æ›´

### Schema ä¿®æ”¹

**æ–‡ä»¶**ï¼š`prisma/schema.prisma`

**æ–°å¢å­—æ®µ**ï¼š
```prisma
model User {
  // ... ç°æœ‰å­—æ®µ ...
  
  streakDays         Int     @default(0)     // è¿ç»­ä¸“æ³¨å¤©æ•°
  lastStreakDate     String?                 // æœ€åä¸€æ¬¡æ›´æ–°çš„æ—¥æœŸ (YYYY-MM-DD)
  totalFocusMinutes  Int     @default(0)     // æ€»ä¸“æ³¨æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
}
```

### è¿ç§»æ­¥éª¤

#### æ­¥éª¤ 1ï¼šç”Ÿæˆè¿ç§»æ–‡ä»¶

```bash
cd C:\Users\ASUS\Desktop\t3-app
npx prisma migrate dev --name add_user_stats_fields
```

**é¢„æœŸè¾“å‡º**ï¼š
```
âœ” Generated Prisma Client
âœ” The migration has been created successfully
```

#### æ­¥éª¤ 2ï¼šåº”ç”¨è¿ç§»

è¿ç§»ä¼šè‡ªåŠ¨åº”ç”¨ï¼Œå¦‚æœéœ€è¦æ‰‹åŠ¨åº”ç”¨ï¼š

```bash
npx prisma migrate deploy
```

#### æ­¥éª¤ 3ï¼šéªŒè¯è¿ç§»

```bash
npx prisma studio
```

æ‰“å¼€ User è¡¨ï¼Œç¡®è®¤æ–°å­—æ®µå­˜åœ¨ï¼š
- `streakDays` (Int, default: 0)
- `lastStreakDate` (String, nullable)
- `totalFocusMinutes` (Int, default: 0)

---

## ğŸ”§ ä»£ç å˜æ›´

### 1. æ–°å¢ API ç«¯ç‚¹

#### `/api/user/stats` (GET)

**åŠŸèƒ½**ï¼šè·å–ç”¨æˆ·ç»Ÿè®¡æ•°æ®

**è¯·æ±‚**ï¼š
```http
GET /api/user/stats
Authorization: Bearer <token>
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "stats": {
    "streakDays": 30,
    "lastStreakDate": "2025-12-23",
    "totalFocusMinutes": 1800
  }
}
```

#### `/api/user/stats/update` (POST)

**åŠŸèƒ½**ï¼šæ›´æ–°ç”¨æˆ·ç»Ÿè®¡æ•°æ®

**è¯·æ±‚**ï¼š
```http
POST /api/user/stats/update
Content-Type: application/json

{
  "streakDays": 31,
  "lastStreakDate": "2025-12-24",
  "totalFocusMinutes": 1860
}
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "stats": {
    "streakDays": 31,
    "lastStreakDate": "2025-12-24",
    "totalFocusMinutes": 1860
  }
}
```

---

### 2. æ–°å¢ Hook

#### `useUserStats`

**æ–‡ä»¶**ï¼š`src/hooks/useUserStats.ts`

**åŠŸèƒ½**ï¼š
- ç®¡ç†è¿ç»­å¤©æ•°å’Œæ€»æ—¶é•¿
- è‡ªåŠ¨ä»æ•°æ®åº“åŠ è½½
- è‡ªåŠ¨åŒæ­¥åˆ°æ•°æ®åº“
- localStorage å¤‡ä»½

**ä½¿ç”¨æ–¹æ³•**ï¼š
```typescript
import { useUserStats } from '~/hooks/useUserStats';

function MyComponent() {
  const {
    streakDays,
    lastStreakDate,
    totalFocusMinutes,
    isLoading,
    updateStreakDays,
    updateTotalMinutes,
    reload,
  } = useUserStats();

  // æ›´æ–°è¿ç»­å¤©æ•°
  const handleUpdateStreak = async () => {
    await updateStreakDays(31, '2025-12-24');
  };

  // å¢åŠ æ€»æ—¶é•¿
  const handleAddMinutes = async (minutes: number) => {
    await updateTotalMinutes(minutes);
  };

  return (
    <div>
      <p>è¿ç»­å¤©æ•°: {streakDays}</p>
      <p>æ€»æ—¶é•¿: {totalFocusMinutes} åˆ†é’Ÿ</p>
    </div>
  );
}
```

---

## ğŸ“Š æ•°æ®è¿ç§»

### è¿ç§»ç°æœ‰ç”¨æˆ·æ•°æ®

**ç›®çš„**ï¼šå°†ç°æœ‰ç”¨æˆ·çš„ localStorage æ•°æ®è¿ç§»åˆ°æ•°æ®åº“

**æ–¹æ³• 1ï¼šå‰ç«¯è‡ªåŠ¨è¿ç§»**ï¼ˆæ¨èï¼‰

`useUserStats` Hook å·²å†…ç½®è‡ªåŠ¨è¿ç§»ï¼š
```typescript
// Hook ä¼šè‡ªåŠ¨æ£€æµ‹ localStorage å’Œæ•°æ®åº“çš„å€¼
// å¦‚æœ localStorage çš„å€¼æ›´å¤§ï¼Œè‡ªåŠ¨åŒæ­¥åˆ°æ•°æ®åº“
if (localStreakDays > dbStreakDays) {
  await fetch('/api/user/stats/update', {
    method: 'POST',
    body: JSON.stringify({ streakDays: localStreakDays }),
  });
}
```

**ç”¨æˆ·æ“ä½œ**ï¼š
1. ç”¨æˆ·ç™»å½•
2. æ‰“å¼€ Dashboard
3. Hook è‡ªåŠ¨åŠ è½½å¹¶è¿ç§»æ•°æ®
4. å®Œæˆï¼

**æ–¹æ³• 2ï¼šåç«¯æ‰¹é‡è¿ç§»**ï¼ˆå¯é€‰ï¼‰

åˆ›å»ºä¸€æ¬¡æ€§è¿ç§»è„šæœ¬ï¼š

```typescript
// scripts/migrate-user-stats.ts
import { db } from '~/server/db';

async function migrateUserStats() {
  const users = await db.user.findMany({
    where: {
      OR: [
        { streakDays: 0 },
        { totalFocusMinutes: 0 },
      ],
    },
  });

  for (const user of users) {
    // ä» FocusSession è®¡ç®—æ€»æ—¶é•¿
    const sessions = await db.focusSession.findMany({
      where: { userId: user.id },
      select: { duration: true },
    });
    
    const totalMinutes = sessions.reduce((sum, s) => sum + (s.duration || 0), 0);

    // æ›´æ–°æ•°æ®åº“
    await db.user.update({
      where: { id: user.id },
      data: { totalFocusMinutes: totalMinutes },
    });

    console.log(`âœ… è¿ç§»ç”¨æˆ· ${user.id}: ${totalMinutes} åˆ†é’Ÿ`);
  }

  console.log('âœ… è¿ç§»å®Œæˆï¼');
}

migrateUserStats();
```

è¿è¡Œï¼š
```bash
npx ts-node scripts/migrate-user-stats.ts
```

---

## ğŸ§ª æµ‹è¯•æ¸…å•

### æµ‹è¯• 1ï¼šæ–°ç”¨æˆ·æ³¨å†Œ

**æ­¥éª¤**ï¼š
1. æ³¨å†Œæ–°ç”¨æˆ·
2. å®Œæˆ Onboarding
3. å®Œæˆä¸€æ¬¡ä¸“æ³¨ï¼ˆ30åˆ†é’Ÿï¼‰
4. æ£€æŸ¥æ•°æ®åº“

**é¢„æœŸ**ï¼š
```sql
SELECT streakDays, totalFocusMinutes FROM "User" WHERE id = '<userId>';
-- streakDays: 0 (ç¬¬äºŒå¤©æ‰ä¼šæ›´æ–°)
-- totalFocusMinutes: 30
```

---

### æµ‹è¯• 2ï¼šè¿ç»­å¤©æ•°æ›´æ–°

**æ­¥éª¤**ï¼š
1. ç”¨æˆ·å®Œæˆç¬¬ä¸€å¤©ä¸“æ³¨
2. ç¬¬äºŒå¤©ç™»å½•
3. å®Œæˆç¬¬äºŒå¤©ä¸“æ³¨
4. æ£€æŸ¥è¿ç»­å¤©æ•°

**é¢„æœŸ**ï¼š
```
Day 1: streakDays = 0
Day 2: streakDays = 1 (æ˜¨å¤©å®Œæˆäº†ç›®æ ‡)
Day 3: streakDays = 2
```

---

### æµ‹è¯• 3ï¼šæ•°æ®æ¢å¤

**æ­¥éª¤**ï¼š
1. ç”¨æˆ·æœ‰æ•°æ®ï¼šstreakDays = 10, totalMinutes = 600
2. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
3. é‡æ–°ç™»å½•
4. æ£€æŸ¥æ•°æ®

**é¢„æœŸ**ï¼š
```
âœ… æ•°æ®ä»æ•°æ®åº“æ¢å¤
âœ… streakDays = 10
âœ… totalMinutes = 600
```

---

### æµ‹è¯• 4ï¼šè·¨è®¾å¤‡åŒæ­¥

**æ­¥éª¤**ï¼š
1. è®¾å¤‡ Aï¼šä¸“æ³¨ 30 åˆ†é’Ÿ
2. è®¾å¤‡ Bï¼šç™»å½•å¹¶æŸ¥çœ‹
3. æ£€æŸ¥æ•°æ®

**é¢„æœŸ**ï¼š
```
âœ… è®¾å¤‡ B æ˜¾ç¤ºæœ€æ–°æ•°æ®
âœ… totalMinutes æ­£ç¡®åŒæ­¥
```

---

### æµ‹è¯• 5ï¼šlocalStorage ä¼˜å…ˆ

**æ­¥éª¤**ï¼š
1. æ•°æ®åº“ï¼šstreakDays = 10
2. localStorageï¼šstreakDays = 15
3. ç”¨æˆ·ç™»å½•
4. æ£€æŸ¥æ•°æ®

**é¢„æœŸ**ï¼š
```
âœ… ä½¿ç”¨ localStorage çš„å€¼ï¼ˆ15ï¼‰
âœ… è‡ªåŠ¨åŒæ­¥åˆ°æ•°æ®åº“ï¼ˆ15ï¼‰
```

---

## ğŸ” éªŒè¯æ–¹æ³•

### æ–¹æ³• 1ï¼šæµè§ˆå™¨æ§åˆ¶å°

```javascript
// 1. æ£€æŸ¥ localStorage
console.log('localStorage:', {
  streakDays: localStorage.getItem('userStreakDays'),
  totalMinutes: localStorage.getItem('totalFocusMinutes'),
});

// 2. æ£€æŸ¥æ•°æ®åº“
fetch('/api/user/stats')
  .then(res => res.json())
  .then(data => console.log('æ•°æ®åº“:', data.stats));

// 3. å¯¹æ¯”
// åº”è¯¥ä¸€è‡´
```

### æ–¹æ³• 2ï¼šPrisma Studio

```bash
npx prisma studio
```

æ‰“å¼€ User è¡¨ï¼ŒæŸ¥çœ‹ï¼š
- `streakDays`
- `lastStreakDate`
- `totalFocusMinutes`

### æ–¹æ³• 3ï¼šæ•°æ®åº“æŸ¥è¯¢

```sql
SELECT 
  id,
  name,
  streakDays,
  lastStreakDate,
  totalFocusMinutes,
  createdAt
FROM "User"
WHERE id = '<userId>';
```

---

## ğŸ“ å›æ»šæ–¹æ¡ˆ

### å¦‚æœéœ€è¦å›æ»š

#### æ­¥éª¤ 1ï¼šå›æ»šæ•°æ®åº“

```bash
npx prisma migrate resolve --rolled-back <migration-name>
```

#### æ­¥éª¤ 2ï¼šåˆ é™¤æ–°å¢æ–‡ä»¶

```bash
rm src/pages/api/user/stats/index.ts
rm src/pages/api/user/stats/update.ts
rm src/hooks/useUserStats.ts
```

#### æ­¥éª¤ 3ï¼šæ¢å¤ schema.prisma

åˆ é™¤æ–°å¢çš„ä¸‰ä¸ªå­—æ®µï¼š
```prisma
model User {
  // åˆ é™¤è¿™ä¸‰è¡Œ
  streakDays         Int     @default(0)
  lastStreakDate     String?
  totalFocusMinutes  Int     @default(0)
}
```

#### æ­¥éª¤ 4ï¼šé‡æ–°ç”Ÿæˆ Prisma Client

```bash
npx prisma generate
```

---

## ğŸš€ éƒ¨ç½²æ¸…å•

### å¼€å‘ç¯å¢ƒ

- [x] âœ… ä¿®æ”¹ `schema.prisma`
- [x] âœ… åˆ›å»º API ç«¯ç‚¹
- [x] âœ… åˆ›å»º `useUserStats` Hook
- [ ] ğŸ”´ è¿è¡Œ `npx prisma migrate dev`
- [ ] ğŸ”´ æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
- [ ] ğŸ”´ éªŒè¯æ•°æ®è¿ç§»

### ç”Ÿäº§ç¯å¢ƒ

- [ ] ğŸ”´ å¤‡ä»½æ•°æ®åº“
- [ ] ğŸ”´ è¿è¡Œ `npx prisma migrate deploy`
- [ ] ğŸ”´ éªŒè¯è¿ç§»æˆåŠŸ
- [ ] ğŸ”´ ç›‘æ§é”™è¯¯æ—¥å¿—
- [ ] ğŸ”´ éªŒè¯ç”¨æˆ·æ•°æ®æ­£ç¡®

---

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### å…³é”®æŒ‡æ ‡

1. **è¿ç§»æˆåŠŸç‡**
   ```sql
   SELECT 
     COUNT(*) as total_users,
     COUNT(CASE WHEN totalFocusMinutes > 0 THEN 1 END) as migrated_users
   FROM "User";
   ```

2. **æ•°æ®ä¸€è‡´æ€§**
   ```typescript
   // æ£€æŸ¥ localStorage å’Œæ•°æ®åº“æ˜¯å¦ä¸€è‡´
   const dbStats = await fetch('/api/user/stats').then(r => r.json());
   const localStreak = parseInt(localStorage.getItem('userStreakDays') || '0');
   
   if (Math.abs(dbStats.stats.streakDays - localStreak) > 1) {
     console.error('âš ï¸ æ•°æ®ä¸ä¸€è‡´ï¼');
   }
   ```

3. **API æ€§èƒ½**
   ```
   GET /api/user/stats - åº”è¯¥ < 100ms
   POST /api/user/stats/update - åº”è¯¥ < 200ms
   ```

---

## ğŸ’¡ å¸¸è§é—®é¢˜

### Q1ï¼šè¿ç§»ä¼šå½±å“ç°æœ‰ç”¨æˆ·å—ï¼Ÿ

**A**ï¼šä¸ä¼šï¼
- æ–°å­—æ®µæœ‰é»˜è®¤å€¼ï¼ˆ0ï¼‰
- ç°æœ‰åŠŸèƒ½ä¸å—å½±å“
- è‡ªåŠ¨è¿ç§»æœºåˆ¶ä¼šåœ¨ç”¨æˆ·ç™»å½•æ—¶è¿è¡Œ

### Q2ï¼šå¦‚æœç”¨æˆ·æœ‰å¤šä¸ªè®¾å¤‡æ€ä¹ˆåŠï¼Ÿ

**A**ï¼šæ•°æ®ä¼šè‡ªåŠ¨åŒæ­¥
- æ¯ä¸ªè®¾å¤‡ç™»å½•æ—¶éƒ½ä¼šä»æ•°æ®åº“åŠ è½½æœ€æ–°æ•°æ®
- ä½¿ç”¨"å–è¾ƒå¤§å€¼"ç­–ç•¥ï¼Œç¡®ä¿æ•°æ®ä¸ä¸¢å¤±

### Q3ï¼šlocalStorage è¿˜æœ‰ç”¨å—ï¼Ÿ

**A**ï¼šæœ‰ï¼
- ä½œä¸ºæœ¬åœ°ç¼“å­˜ï¼Œæå‡æ€§èƒ½
- ä½œä¸ºå¤‡ä»½ï¼Œé˜²æ­¢æ•°æ®åº“æ•…éšœ
- ç¦»çº¿æ—¶ä»å¯ä½¿ç”¨

### Q4ï¼šå¦‚ä½•å¤„ç†æ•°æ®å†²çªï¼Ÿ

**A**ï¼šä½¿ç”¨"å–è¾ƒå¤§å€¼"ç­–ç•¥
```typescript
const finalValue = Math.max(dbValue, localValue);
```
è¿™æ ·ç¡®ä¿ç”¨æˆ·çš„åŠªåŠ›ä¸ä¼šä¸¢å¤±ã€‚

---

## ğŸ¯ é¢„æœŸæ•ˆæœ

### ä¼˜åŒ–å‰

```
âŒ æ¸…é™¤ç¼“å­˜ â†’ è¿ç»­å¤©æ•°ä¸¢å¤±
âŒ æ¢è®¾å¤‡ â†’ æ•°æ®ä¸åŒæ­¥
âŒ æ•°æ®æ¢å¤ â†’ æ— æ³•æ¢å¤
```

### ä¼˜åŒ–å

```
âœ… æ¸…é™¤ç¼“å­˜ â†’ ä»æ•°æ®åº“æ¢å¤
âœ… æ¢è®¾å¤‡ â†’ è‡ªåŠ¨åŒæ­¥
âœ… æ•°æ®æ¢å¤ â†’ å®Œå…¨æ¢å¤
âœ… æ•°æ®å®‰å…¨ â†’ æ°¸ä¹…ä¿å­˜
```

---

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿã€‚

**å®æ–½æ—¥æœŸ**ï¼š2025-12-23  
**ç‰ˆæœ¬**ï¼šv3.3.0  
**çŠ¶æ€**ï¼šâœ… å‡†å¤‡å°±ç»ª

---

**ä¸‹ä¸€æ­¥**ï¼š
1. è¿è¡Œ `npx prisma migrate dev --name add_user_stats_fields`
2. æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
3. éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

æ‰€æœ‰å‡†å¤‡å·¥ä½œå·²å®Œæˆï¼Œå¯ä»¥å®‰å…¨éƒ¨ç½²ï¼ğŸš€



