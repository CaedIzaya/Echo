# ğŸ“Š å‘¨æŠ¥é‚®ä»¶å’Œè¿ç»­å¤©æ•°åŠŸèƒ½ - è¯Šæ–­æŠ¥å‘Š

## ğŸ¯ æ£€æŸ¥é¡¹ç›®

1. **å‘¨æŠ¥é‚®ä»¶å‘é€**ï¼šæ¯å‘¨ä¸€æ˜¯å¦è‡ªåŠ¨å‘é€åˆ°ç”¨æˆ·é‚®ç®±
2. **è¿ç»­å¤©æ•°å åŠ **ï¼šå®Œæˆæœ€å°ä¸“æ³¨æ—¶é•¿åæ˜¯å¦æ­£ç¡®+1ï¼Œä¸”æ°¸ä¸æ¸…é›¶

---

## ğŸ” è¯Šæ–­ç»“æœ

### 1ï¸âƒ£ å‘¨æŠ¥é‚®ä»¶å‘é€åŠŸèƒ½

#### âŒ **é—®é¢˜ï¼šå‘¨æŠ¥é‚®ä»¶åŠŸèƒ½æœªå®ç°**

**ç°çŠ¶åˆ†æ**ï¼š

âœ… **å·²å®ç°çš„éƒ¨åˆ†**ï¼š
- âœ… å‘¨æŠ¥æ•°æ®ç”Ÿæˆé€»è¾‘ï¼ˆ`src/lib/weeklyReport.ts`ï¼‰
- âœ… å‘¨æŠ¥ API ç«¯ç‚¹ï¼ˆ`src/pages/api/weekly-report/index.ts`ï¼‰
- âœ… å‘¨æŠ¥æ•°æ®åº“å­˜å‚¨ï¼ˆ`WeeklyReport` è¡¨ï¼‰
- âœ… å‘¨æŠ¥é¡µé¢å±•ç¤ºï¼ˆ`src/pages/reports/weekly.tsx`ï¼‰

âŒ **ç¼ºå¤±çš„éƒ¨åˆ†**ï¼š
- âŒ **æ²¡æœ‰é‚®ä»¶å‘é€åŠŸèƒ½**ï¼ˆæ—  nodemailer æˆ–å…¶ä»–é‚®ä»¶æœåŠ¡ï¼‰
- âŒ **æ²¡æœ‰å®šæ—¶ä»»åŠ¡**ï¼ˆæ—  cron job æˆ– Vercel Cronï¼‰
- âŒ **æ²¡æœ‰é‚®ä»¶æ¨¡æ¿**
- âŒ **æ²¡æœ‰ SMTP é…ç½®**

**è¯æ®**ï¼š
```bash
# æ£€æŸ¥é‚®ä»¶ç›¸å…³ä¾èµ–
package.json: âŒ æ²¡æœ‰ nodemailer
package.json: âŒ æ²¡æœ‰ @sendgrid/mail
package.json: âŒ æ²¡æœ‰å…¶ä»–é‚®ä»¶æœåŠ¡

# æ£€æŸ¥å®šæ—¶ä»»åŠ¡
vercel.json: âŒ ä¸å­˜åœ¨ï¼ˆæ—  Vercel Cron é…ç½®ï¼‰
scripts/: âŒ æ²¡æœ‰å‘¨æŠ¥å‘é€è„šæœ¬

# æ£€æŸ¥ç¯å¢ƒå˜é‡
.env.example: âŒ æ²¡æœ‰ SMTP æˆ–é‚®ä»¶æœåŠ¡é…ç½®
```

**ç»“è®º**ï¼š
> ğŸ“§ **å‘¨æŠ¥é‚®ä»¶åŠŸèƒ½ç›®å‰åªæ˜¯æ•°æ®ç”Ÿæˆå’Œå±•ç¤ºï¼Œæ²¡æœ‰å®é™…çš„é‚®ä»¶å‘é€åŠŸèƒ½ã€‚**
> 
> ç”¨æˆ·éœ€è¦æ‰‹åŠ¨è®¿é—® `/reports/weekly` é¡µé¢æŸ¥çœ‹å‘¨æŠ¥ï¼Œä¸ä¼šæ”¶åˆ°é‚®ä»¶ã€‚

---

### 2ï¸âƒ£ è¿ç»­å¤©æ•°å åŠ åŠŸèƒ½

#### âœ… **åŠŸèƒ½æ­£å¸¸ï¼šé€»è¾‘æ­£ç¡®å®ç°**

**ä»£ç ä½ç½®**ï¼š`src/pages/dashboard/index.tsx` (ç¬¬870-881è¡Œ)

**å®ç°é€»è¾‘**ï¼š

```typescript:870:881:src/pages/dashboard/index.tsx
// æ›´æ–°ç´¯è®¡å¤©æ•°ï¼ˆç´¯è®¡å¤©æ•°é€»è¾‘ï¼šåªè¦å®Œæˆäº†ä¸€æ¬¡æœ€å°æ¯æ—¥ä¸“æ³¨æ—¶é•¿ç›®æ ‡ï¼Œå³å¯+1ï¼Œä¸ä¼šå› ä¸ºç¬¬äºŒå¤©æ²¡ä¸Šçº¿è€Œä¸­æ–­ï¼‰
// åˆ¤æ–­æ˜¨å¤©æ˜¯å¦å®Œæˆäº†æ¯æ—¥ç›®æ ‡
const dailyGoalMinutes = primaryPlan?.dailyGoalMinutes || 0;
const yesterdayCompletedGoal = dailyGoalMinutes > 0 
  ? yesterdayMinutes >= dailyGoalMinutes 
  : yesterdayMinutes >= MIN_FOCUS_MINUTES;

// å¦‚æœæ˜¨å¤©å®Œæˆäº†ç›®æ ‡ï¼Œç´¯è®¡å¤©æ•°+1ï¼›å¦‚æœæ²¡å®Œæˆï¼Œç´¯è®¡å¤©æ•°ä¸å˜ï¼ˆä¸ä¼šå‡å°‘ï¼‰
const newStreakDays = yesterdayCompletedGoal 
  ? stats.streakDays + 1 
  : stats.streakDays;
updateStats({ streakDays: newStreakDays });
```

**é€»è¾‘éªŒè¯**ï¼š

âœ… **å®Œæˆç›®æ ‡çš„åˆ¤æ–­**ï¼š
- å¦‚æœæœ‰ä¸»è¦è®¡åˆ’ï¼š`æ˜¨æ—¥æ—¶é•¿ >= è®¡åˆ’æ¯æ—¥ç›®æ ‡æ—¶é•¿`
- å¦‚æœæ²¡æœ‰ä¸»è¦è®¡åˆ’ï¼š`æ˜¨æ—¥æ—¶é•¿ >= 25åˆ†é’Ÿ`ï¼ˆMIN_FOCUS_MINUTESï¼‰

âœ… **è¿ç»­å¤©æ•°æ›´æ–°**ï¼š
- **å®Œæˆç›®æ ‡**ï¼š`streakDays + 1` âœ…
- **æœªå®Œæˆç›®æ ‡**ï¼š`streakDays`ï¼ˆä¿æŒä¸å˜ï¼‰âœ…
- **æ°¸ä¸æ¸…é›¶**ï¼šæ²¡æœ‰ä»»ä½•ä»£ç ä¼šå°† `streakDays` é‡ç½®ä¸º 0 æˆ– 1 âœ…

âœ… **è§¦å‘æ—¶æœº**ï¼š
- åœ¨"æ–°çš„ä¸€å¤©"å¼€å§‹æ—¶æ£€æŸ¥æ˜¨æ—¥æ•°æ®
- åªåœ¨ä¸“æ³¨å®Œæˆåè§¦å‘ï¼ˆ`handleFocusSessionComplete`ï¼‰
- ä½¿ç”¨ `lastFocusDate` åˆ¤æ–­æ˜¯å¦æ˜¯æ–°çš„ä¸€å¤©

**æ•°æ®å­˜å‚¨**ï¼š
```typescript
localStorage.setItem('dashboardStats', JSON.stringify({
  yesterdayMinutes: number,
  streakDays: number,  // âœ… æŒä¹…åŒ–å­˜å‚¨
  completedGoals: number
}));
```

**ç»“è®º**ï¼š
> âœ… **è¿ç»­å¤©æ•°åŠŸèƒ½å®Œå…¨æ­£å¸¸ï¼**
> 
> - å®Œæˆæœ€å°ä¸“æ³¨æ—¶é•¿åä¼š +1
> - æœªå®Œæˆæ—¶ä¿æŒä¸å˜ï¼ˆä¸ä¼šå‡å°‘ï¼‰
> - æ°¸è¿œä¸ä¼šè¢«æ¸…é›¶
> - æ•°æ®æŒä¹…åŒ–åˆ° localStorage

---

## ğŸ”§ ä¿®å¤å»ºè®®

### é—®é¢˜ 1ï¼šå‘¨æŠ¥é‚®ä»¶å‘é€

#### æ–¹æ¡ˆ Aï¼šä½¿ç”¨ Resendï¼ˆæ¨èï¼‰

**ä¼˜ç‚¹**ï¼š
- ğŸ¯ ä¸“ä¸º Next.js è®¾è®¡
- ğŸ¯ å…è´¹é¢åº¦ï¼šæ¯æœˆ 3000 å°
- ğŸ¯ ç®€å•æ˜“ç”¨
- ğŸ¯ æ”¯æŒ React Email æ¨¡æ¿

**å®ç°æ­¥éª¤**ï¼š

1. **å®‰è£…ä¾èµ–**ï¼š
```bash
npm install resend
npm install react-email @react-email/components
```

2. **é…ç½®ç¯å¢ƒå˜é‡**ï¼ˆ`.env`ï¼‰ï¼š
```env
RESEND_API_KEY=re_xxxxx
RESEND_FROM_EMAIL=weekly@yourdomain.com
```

3. **åˆ›å»ºé‚®ä»¶æ¨¡æ¿**ï¼ˆ`src/emails/WeeklyReport.tsx`ï¼‰ï¼š
```typescript
import { Html, Head, Body, Container, Section, Text, Heading } from '@react-email/components';

export default function WeeklyReportEmail({ report }) {
  return (
    <Html>
      <Head />
      <Body style={{ backgroundColor: '#f6f9fc' }}>
        <Container>
          <Heading>ğŸ“Š ä½ çš„æœ¬å‘¨ä¸“æ³¨æŠ¥å‘Š</Heading>
          <Section>
            <Text>æœ¬å‘¨ä¸“æ³¨æ—¶é•¿ï¼š{report.totals.minutes} åˆ†é’Ÿ</Text>
            <Text>è¿ç»­ä¸“æ³¨ï¼š{report.totals.streakDays} å¤©</Text>
            {/* æ›´å¤šå†…å®¹ */}
          </Section>
        </Container>
      </Body>
    </Html>
  );
}
```

4. **åˆ›å»ºå‘é€ API**ï¼ˆ`src/pages/api/send-weekly-report.ts`ï¼‰ï¼š
```typescript
import { Resend } from 'resend';
import { computeWeeklyReport } from '~/lib/weeklyReport';
import WeeklyReportEmail from '~/emails/WeeklyReport';

const resend = new Resend(process.env.RESEND_API_KEY);

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'æ–¹æ³•ä¸å…è®¸' });
  }

  try {
    const { userId, userEmail } = req.body;
    
    // ç”Ÿæˆå‘¨æŠ¥æ•°æ®
    const report = await computeWeeklyReport(userId);
    
    // å‘é€é‚®ä»¶
    const { data, error } = await resend.emails.send({
      from: process.env.RESEND_FROM_EMAIL,
      to: userEmail,
      subject: `ğŸ“Š ${report.period.label} å‘¨æŠ¥`,
      react: WeeklyReportEmail({ report }),
    });

    if (error) {
      console.error('[send-weekly-report] å‘é€å¤±è´¥:', error);
      return res.status(500).json({ error: error.message });
    }

    console.log('[send-weekly-report] å‘é€æˆåŠŸ:', data.id);
    return res.status(200).json({ success: true, id: data.id });
  } catch (error) {
    console.error('[send-weekly-report] é”™è¯¯:', error);
    return res.status(500).json({ error: error.message });
  }
}
```

5. **é…ç½® Vercel Cron**ï¼ˆåˆ›å»º `vercel.json`ï¼‰ï¼š
```json
{
  "crons": [
    {
      "path": "/api/cron/send-weekly-reports",
      "schedule": "0 9 * * 1"
    }
  ]
}
```

6. **åˆ›å»º Cron å¤„ç†å™¨**ï¼ˆ`src/pages/api/cron/send-weekly-reports.ts`ï¼‰ï¼š
```typescript
import { db } from '~/server/db';

export default async function handler(req, res) {
  // éªŒè¯ Cron å¯†é’¥
  if (req.headers.authorization !== `Bearer ${process.env.CRON_SECRET}`) {
    return res.status(401).json({ error: 'æœªæˆæƒ' });
  }

  try {
    // è·å–æ‰€æœ‰æ³¨å†Œè¶…è¿‡7å¤©çš„ç”¨æˆ·
    const users = await db.user.findMany({
      where: {
        createdAt: {
          lte: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
        },
        email: { not: null }
      },
      select: { id: true, email: true }
    });

    console.log(`[cron] å¼€å§‹å‘é€å‘¨æŠ¥ï¼Œç”¨æˆ·æ•°: ${users.length}`);

    // æ‰¹é‡å‘é€
    const results = await Promise.allSettled(
      users.map(user =>
        fetch(`${process.env.NEXTAUTH_URL}/api/send-weekly-report`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: user.id, userEmail: user.email })
        })
      )
    );

    const success = results.filter(r => r.status === 'fulfilled').length;
    const failed = results.filter(r => r.status === 'rejected').length;

    console.log(`[cron] å‘¨æŠ¥å‘é€å®Œæˆ: æˆåŠŸ ${success}, å¤±è´¥ ${failed}`);

    return res.status(200).json({ 
      success: true, 
      total: users.length,
      success: success,
      failed: failed
    });
  } catch (error) {
    console.error('[cron] å‘é€å‘¨æŠ¥å¤±è´¥:', error);
    return res.status(500).json({ error: error.message });
  }
}
```

7. **æ·»åŠ ç¯å¢ƒå˜é‡**ï¼š
```env
CRON_SECRET=your-random-secret-key
NEXTAUTH_URL=https://yourdomain.com
```

#### æ–¹æ¡ˆ Bï¼šä½¿ç”¨ Nodemailerï¼ˆè‡ªå»º SMTPï¼‰

**ä¼˜ç‚¹**ï¼š
- å®Œå…¨æ§åˆ¶
- å¯ä»¥ä½¿ç”¨è‡ªå·±çš„é‚®ä»¶æœåŠ¡å™¨

**ç¼ºç‚¹**ï¼š
- é…ç½®å¤æ‚
- éœ€è¦ SMTP æœåŠ¡å™¨
- å¯èƒ½è¢«æ ‡è®°ä¸ºåƒåœ¾é‚®ä»¶

**å®ç°æ­¥éª¤**ï¼š

1. **å®‰è£…ä¾èµ–**ï¼š
```bash
npm install nodemailer
npm install @types/nodemailer --save-dev
```

2. **é…ç½®ç¯å¢ƒå˜é‡**ï¼š
```env
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
SMTP_FROM=weekly@yourdomain.com
```

3. **åˆ›å»ºé‚®ä»¶æœåŠ¡**ï¼ˆ`src/lib/emailService.ts`ï¼‰ï¼š
```typescript
import nodemailer from 'nodemailer';

const transporter = nodemailer.createTransporter({
  host: process.env.SMTP_HOST,
  port: parseInt(process.env.SMTP_PORT || '587'),
  secure: false,
  auth: {
    user: process.env.SMTP_USER,
    pass: process.env.SMTP_PASS,
  },
});

export async function sendWeeklyReportEmail(to: string, report: any) {
  const html = generateWeeklyReportHTML(report);
  
  const info = await transporter.sendMail({
    from: process.env.SMTP_FROM,
    to,
    subject: `ğŸ“Š ${report.period.label} å‘¨æŠ¥`,
    html,
  });

  return info;
}

function generateWeeklyReportHTML(report: any) {
  return `
    <!DOCTYPE html>
    <html>
      <head>
        <style>
          body { font-family: Arial, sans-serif; background-color: #f6f9fc; }
          .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; }
          .header { text-align: center; color: #333; }
          .stats { margin: 20px 0; }
          .stat-item { padding: 10px; border-bottom: 1px solid #eee; }
        </style>
      </head>
      <body>
        <div class="container">
          <h1 class="header">ğŸ“Š ä½ çš„æœ¬å‘¨ä¸“æ³¨æŠ¥å‘Š</h1>
          <p>å‘¨æœŸï¼š${report.period.label}</p>
          <div class="stats">
            <div class="stat-item">
              <strong>æœ¬å‘¨ä¸“æ³¨æ—¶é•¿ï¼š</strong> ${report.totals.minutes} åˆ†é’Ÿ
            </div>
            <div class="stat-item">
              <strong>è¿ç»­ä¸“æ³¨ï¼š</strong> ${report.totals.streakDays} å¤©
            </div>
            <div class="stat-item">
              <strong>å¿ƒæµæŒ‡æ•°ï¼š</strong> ${report.totals.flowAvg || 'N/A'}
            </div>
          </div>
        </div>
      </body>
    </html>
  `;
}
```

---

### é—®é¢˜ 2ï¼šè¿ç»­å¤©æ•°

#### âœ… æ— éœ€ä¿®å¤

è¿ç»­å¤©æ•°åŠŸèƒ½å®Œå…¨æ­£å¸¸ï¼Œé€»è¾‘æ­£ç¡®å®ç°ã€‚

**éªŒè¯æ–¹æ³•**ï¼š

1. **æŸ¥çœ‹å½“å‰è¿ç»­å¤©æ•°**ï¼š
   - æ‰“å¼€ Dashboard
   - æŸ¥çœ‹"è¿ç»­ä¸“æ³¨"å¡ç‰‡

2. **æµ‹è¯•å åŠ é€»è¾‘**ï¼š
```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°è¿è¡Œ
const stats = JSON.parse(localStorage.getItem('dashboardStats') || '{}');
console.log('å½“å‰è¿ç»­å¤©æ•°:', stats.streakDays);

// æ¨¡æ‹Ÿå®Œæˆä¸€å¤©ï¼ˆä»…æµ‹è¯•ç”¨ï¼‰
stats.streakDays += 1;
localStorage.setItem('dashboardStats', JSON.stringify(stats));
window.location.reload();
```

3. **æ£€æŸ¥æ—¥å¿—**ï¼š
   - å®Œæˆä¸“æ³¨åæŸ¥çœ‹æ§åˆ¶å°
   - åº”è¯¥çœ‹åˆ°ï¼š`ğŸ”„ æ—¥æœŸå·²æ›´æ–° { today: "2025-12-23", newStreakDays: X }`

---

## ğŸ“Š åŠŸèƒ½å¯¹æ¯”è¡¨

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| å‘¨æŠ¥æ•°æ®ç”Ÿæˆ | âœ… æ­£å¸¸ | å¯ä»¥ç”Ÿæˆå®Œæ•´çš„å‘¨æŠ¥æ•°æ® |
| å‘¨æŠ¥é¡µé¢å±•ç¤º | âœ… æ­£å¸¸ | ç”¨æˆ·å¯ä»¥è®¿é—® `/reports/weekly` æŸ¥çœ‹ |
| å‘¨æŠ¥æ•°æ®åº“å­˜å‚¨ | âœ… æ­£å¸¸ | å‘¨æŠ¥æ•°æ®ä¿å­˜åˆ° `WeeklyReport` è¡¨ |
| **å‘¨æŠ¥é‚®ä»¶å‘é€** | âŒ **æœªå®ç°** | **æ²¡æœ‰é‚®ä»¶å‘é€åŠŸèƒ½** |
| **å®šæ—¶ä»»åŠ¡** | âŒ **æœªå®ç°** | **æ²¡æœ‰è‡ªåŠ¨è§¦å‘æœºåˆ¶** |
| è¿ç»­å¤©æ•°å åŠ  | âœ… æ­£å¸¸ | å®Œæˆç›®æ ‡å +1ï¼Œæœªå®Œæˆä¿æŒä¸å˜ |
| è¿ç»­å¤©æ•°æ°¸ä¸æ¸…é›¶ | âœ… æ­£å¸¸ | æ²¡æœ‰ä»»ä½•é‡ç½®é€»è¾‘ |
| è¿ç»­å¤©æ•°æŒä¹…åŒ– | âœ… æ­£å¸¸ | ä¿å­˜åˆ° localStorage |

---

## ğŸ¯ æ€»ç»“

### é—®é¢˜ 1ï¼šå‘¨æŠ¥é‚®ä»¶ âŒ

**ç°çŠ¶**ï¼š
- âŒ æ²¡æœ‰é‚®ä»¶å‘é€åŠŸèƒ½
- âŒ æ²¡æœ‰å®šæ—¶ä»»åŠ¡
- âŒ ç”¨æˆ·ä¸ä¼šæ”¶åˆ°é‚®ä»¶

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. âœ… ä½¿ç”¨ Resendï¼ˆæ¨èï¼‰- ç®€å•å¿«é€Ÿ
2. âœ… ä½¿ç”¨ Nodemailer - å®Œå…¨æ§åˆ¶
3. âœ… é…ç½® Vercel Cron - æ¯å‘¨ä¸€è‡ªåŠ¨å‘é€

**é¢„è®¡å·¥ä½œé‡**ï¼š
- æ–¹æ¡ˆ Aï¼ˆResendï¼‰ï¼š2-3 å°æ—¶
- æ–¹æ¡ˆ Bï¼ˆNodemailerï¼‰ï¼š4-5 å°æ—¶

### é—®é¢˜ 2ï¼šè¿ç»­å¤©æ•° âœ…

**ç°çŠ¶**ï¼š
- âœ… åŠŸèƒ½å®Œå…¨æ­£å¸¸
- âœ… é€»è¾‘æ­£ç¡®å®ç°
- âœ… æ°¸ä¸æ¸…é›¶

**æ— éœ€ä¿®å¤**ï¼

---

## ğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³å¯åš

1. **éªŒè¯è¿ç»­å¤©æ•°**ï¼š
   - å®Œæˆä¸€æ¬¡ä¸“æ³¨ï¼ˆâ‰¥25åˆ†é’Ÿï¼‰
   - ç­‰åˆ°ç¬¬äºŒå¤©
   - æŸ¥çœ‹è¿ç»­å¤©æ•°æ˜¯å¦ +1

2. **æŸ¥çœ‹å‘¨æŠ¥æ•°æ®**ï¼š
   - è®¿é—® `/reports/weekly`
   - ç¡®è®¤å‘¨æŠ¥æ•°æ®æ­£ç¡®ç”Ÿæˆ

### éœ€è¦å®æ–½ï¼ˆå‘¨æŠ¥é‚®ä»¶ï¼‰

1. **é€‰æ‹©é‚®ä»¶æ–¹æ¡ˆ**ï¼šResend æˆ– Nodemailer
2. **å®æ–½é‚®ä»¶å‘é€åŠŸèƒ½**
3. **é…ç½®å®šæ—¶ä»»åŠ¡**
4. **æµ‹è¯•é‚®ä»¶å‘é€**
5. **éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ**

---

**è¯Šæ–­æ—¥æœŸ**ï¼š2025-12-23  
**è¯Šæ–­äºº**ï¼šAI Assistant  
**çŠ¶æ€**ï¼š
- âŒ å‘¨æŠ¥é‚®ä»¶ï¼šæœªå®ç°ï¼Œéœ€è¦å¼€å‘
- âœ… è¿ç»­å¤©æ•°ï¼šæ­£å¸¸å·¥ä½œï¼Œæ— éœ€ä¿®å¤





