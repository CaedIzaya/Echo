# 🚀 部署检查清单

## 部署前必须完成的步骤

### 1. 数据库迁移 ✅

运行以下命令应用新的数据库索引：

```bash
npm run db:push
```

这将添加以下索引：
- ✅ FocusSession: `[userId, startTime]` 和 `[userId, createdAt]`
- ✅ DailySummary: `[userId, date]` 和 `[date]`
- ✅ User: `[createdAt]` 和 `[email]`

### 2. 验证数据库健康 ✅

```bash
npm run db:health-check
```

确保所有检查项都通过。

### 3. 环境变量检查

确认以下环境变量已在Vercel中配置：

- ✅ `DATABASE_URL` - 数据库连接字符串
- ✅ `NEXTAUTH_URL` - 应用URL
- ✅ `NEXTAUTH_SECRET` - NextAuth密钥
- ✅ `NODE_ENV` - 设置为 `production`

### 4. 功能测试

在部署前，在本地测试以下功能：

#### 周报功能
- [ ] 新用户（注册<7天）访问周报 → 应显示友好提示
- [ ] 老用户（注册≥7天）访问周报 → 应正常显示
- [ ] 周报数据能正确计算和显示
- [ ] 周报能正确保存到数据库

#### 专注会话
- [ ] 能正常创建专注会话
- [ ] 数据能正确保存到数据库
- [ ] 每日小结能自动刷新
- [ ] 异常时长会被拒绝（>24小时）

#### 数据完整性
- [ ] 删除用户时关联数据被级联删除
- [ ] 数据验证正常工作
- [ ] 错误日志能正确记录

### 5. 性能验证

```bash
# 启动本地生产环境
npm run build
npm start

# 测试周报生成速度（应在5秒内）
time curl http://localhost:3000/api/weekly-report
```

### 6. 日志检查

确保以下日志正常输出：

- `[weekly-report]` - 周报操作
- `[focus-sessions]` - 专注会话
- `[refreshDailySummary]` - 每日小结
- `[persistWeekly]` - 周报持久化

## 部署步骤

### Vercel部署

1. **推送代码到Git**
```bash
git add .
git commit -m "feat: 优化周报和数据库性能"
git push origin main
```

2. **Vercel自动部署**
   - Vercel会自动检测推送并开始部署
   - 等待构建完成（约3-5分钟）

3. **运行数据库迁移**
```bash
# 在Vercel项目设置中，或通过CLI
npx prisma db push --skip-generate
```

4. **验证部署**
   - 访问生产环境URL
   - 测试周报功能
   - 检查日志（Vercel控制台 → Logs）

## 部署后验证

### 1. 功能测试
- [ ] 登录/注册功能正常
- [ ] 专注计时器正常工作
- [ ] 周报能正常生成和显示
- [ ] 每日小结正常保存

### 2. 性能监控
- [ ] 检查响应时间（应<3秒）
- [ ] 检查数据库查询性能
- [ ] 监控内存使用

### 3. 错误监控
```bash
# 在Vercel控制台查看实时日志
vercel logs --follow
```

关注以下错误：
- 数据库连接错误
- 周报生成错误
- 数据验证错误

### 4. 用户测试
- [ ] 创建测试账号（新用户）
- [ ] 尝试访问周报 → 应看到"注册时间不足"提示
- [ ] 进行一次专注 → 数据应正确保存
- [ ] 等待7天后再次测试周报功能

## 回滚计划

如果部署出现问题：

### 快速回滚
```bash
# 在Vercel控制台
1. Deployments → 找到上一个稳定版本
2. 点击 "Promote to Production"
```

### 数据库回滚
```bash
# 如果需要回滚数据库schema
1. 恢复之前的schema.prisma
2. 运行 npm run db:push
```

### 数据恢复
```bash
# 如果数据损坏，从备份恢复
psql $DATABASE_URL < backup_latest.sql
```

## 监控和维护

### 日常监控
- 每天检查Vercel日志
- 监控错误率和响应时间
- 关注用户反馈

### 定期维护
- **每周**: 运行健康检查 `npm run db:health-check`
- **每周**: 清理过期数据 `npm run cleanup:expired`
- **每月**: 完整数据库备份
- **每月**: 性能审查

### 告警设置
在Vercel中设置告警：
- 错误率 > 5%
- 响应时间 > 5秒
- 部署失败

## 故障排查

### 问题：周报加载失败

**检查步骤：**
1. 查看Vercel日志
2. 检查数据库连接
3. 验证用户注册日期
4. 运行健康检查

**常见原因：**
- 用户注册不足7天 ✅（正常，会显示提示）
- 数据库查询超时 → 检查索引
- 数据格式错误 → 运行健康检查

### 问题：数据库连接超时

**解决方案：**
1. 检查DATABASE_URL配置
2. 验证Vercel Postgres状态
3. 检查连接池设置
4. 考虑升级数据库计划

### 问题：内存不足

**解决方案：**
1. 优化查询（使用select选择字段）
2. 添加查询限制（take/skip）
3. 清理过期数据
4. 升级Vercel计划

## 性能优化建议

已实现的优化：
- ✅ 数据库索引优化
- ✅ 查询选择性优化
- ✅ 事务处理
- ✅ 异步非阻塞操作
- ✅ 数据验证和过滤

未来优化方向：
- [ ] 添加Redis缓存
- [ ] 实现查询结果缓存
- [ ] CDN加速静态资源
- [ ] 数据库读写分离（大规模时）

## 安全检查

- ✅ 所有API都有身份验证
- ✅ 数据验证和清洗
- ✅ SQL注入防护（Prisma ORM）
- ✅ 敏感数据不在日志中
- ✅ 环境变量安全存储

## 联系和支持

如果遇到问题：
1. 查看日志文件
2. 运行健康检查
3. 查看DATABASE_MAINTENANCE.md
4. 联系开发团队

---

**最后更新**: 2024-12-16
**版本**: 2.0
**状态**: ✅ 准备就绪










