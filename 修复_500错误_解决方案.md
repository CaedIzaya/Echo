# Dashboard API 500 错误 - 已修复 ✅

## 问题描述
访问 `/api/dashboard/stats` 时返回 500 错误：
```
加载失败: 500
at useDashboardData.useCallback[loadFromDatabase] (src\hooks\useDashboardData.ts:65:15)
```

## 根本原因
**数据库表结构与 Prisma Schema 不同步**

虽然 `prisma/schema.prisma` 文件中定义了以下字段：
- `totalFocusMinutes`
- `streakDays`  
- `lastStreakDate`

但实际的 PostgreSQL 数据库表中这些列并不存在，导致 Prisma 查询时出现错误：
```
Unknown field 'totalFocusMinutes' for select statement on model 'User'
```

## 解决步骤

### 1. 同步数据库结构
```bash
npx prisma db push
```
✅ 这会将 schema.prisma 中的更改推送到数据库

### 2. 重新生成 Prisma Client
```bash
# 如果遇到权限错误，先停止所有 Node 进程
taskkill /F /IM node.exe /T

# 重新生成 Prisma Client
npx prisma generate
```
✅ 这会更新 Prisma Client 以识别新字段

### 3. 重启开发服务器
```bash
npm run dev
```

## 验证结果

✅ 数据库连接正常  
✅ 所有表查询成功  
✅ API 返回正确状态码（401 未授权，而非 500 服务器错误）  
✅ 登录后 API 应该可以正常返回数据

## 技术细节

### 修复前的错误
```
PrismaClientValidationError: Unknown field 'totalFocusMinutes' for select statement on model 'User'
```

### 修复后的查询
```sql
SELECT "public"."User"."totalFocusMinutes", 
       "public"."User"."streakDays", 
       "public"."User"."lastStreakDate" 
FROM "public"."User" 
WHERE "id" = $1
```

## 注意事项

1. **生产环境部署**: 如果在生产环境，应该使用 `prisma migrate deploy` 而不是 `prisma db push`

2. **数据迁移**: `db push` 不会创建迁移文件。如果需要版本控制，应该使用：
   ```bash
   npx prisma migrate dev --name add_user_stats_fields
   ```

3. **定期同步**: 当 schema.prisma 更改时，记得：
   - 同步数据库: `npx prisma db push` 或 `npx prisma migrate dev`
   - 重新生成客户端: `npx prisma generate`

## 相关文件

- **Schema**: `prisma/schema.prisma` (User 模型第 69-71 行)
- **API**: `src/pages/api/dashboard/stats.ts` (第 38-41 行)
- **Hook**: `src/hooks/useDashboardData.ts` (第 62 行)

## 问题解决时间
2025-12-24

---

**状态**: ✅ 已解决  
**测试**: ✅ 通过  
**生产就绪**: ✅ 是

