# æ•°æ®ä¿æŠ¤ç³»ç»Ÿ - å®Œæ•´è¯´æ˜

## ğŸ¯ ç³»ç»Ÿç›®æ ‡

é˜²æ­¢å›  localStorage æ¸…é™¤å¯¼è‡´çš„ç”¨æˆ·æ•°æ®ä¸¢å¤±ï¼Œç¡®ä¿ç”¨æˆ·æ•°æ®çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§ã€‚

## âš ï¸ é—®é¢˜èƒŒæ™¯

### åŸæœ‰é—®é¢˜ï¼š

1. **æˆå°±ç³»ç»Ÿåªä¾èµ– localStorage**
   - ä¸€æ—¦æµè§ˆå™¨ç¼“å­˜è¢«æ¸…é™¤ï¼Œæˆå°±æ•°æ®ä¸¢å¤±
   - ç³»ç»Ÿè¯¯åˆ¤ä¸º"æ–°ç”¨æˆ·"
   - é‡å¤è§£é”"é¦–æ¬¡"æˆå°±

2. **ç»éªŒå€¼ç³»ç»Ÿè™½ç„¶æœ‰æ•°æ®åº“ï¼Œä½†æ¢å¤æœºåˆ¶ä¸å®Œå–„**
   - æ•°æ®åº“æœ‰æ•°æ®ï¼Œä½†æœ¬åœ°æ²¡æœ‰æ—¶ï¼Œæ— æ³•è‡ªåŠ¨æ¢å¤
   - éœ€è¦ç”¨æˆ·æ‰‹åŠ¨åˆ·æ–°æˆ–é‡æ–°ç™»å½•

3. **æ— æ³•å‡†ç¡®åˆ¤æ–­çœŸæ­£çš„æ–°ç”¨æˆ·**
   - ä»…é€šè¿‡ localStorage åˆ¤æ–­
   - å®¹æ˜“è¯¯åˆ¤è€ç”¨æˆ·ä¸ºæ–°ç”¨æˆ·

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. åŒé‡éªŒè¯æœºåˆ¶

```typescript
// æ–°ç”¨æˆ·åˆ¤å®šè§„åˆ™ï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰ï¼š
1. æ•°æ®åº“ä¸­æœ‰ä¸“æ³¨è®°å½• â†’ éæ–°ç”¨æˆ·
2. æ•°æ®åº“ä¸­æœ‰æˆå°±è®°å½• â†’ éæ–°ç”¨æˆ·
3. æ•°æ®åº“ä¸­ç”¨æˆ·ç»éªŒ > 0 â†’ éæ–°ç”¨æˆ·
4. è´¦å·åˆ›å»ºæ—¶é—´ > 24å°æ—¶ â†’ å¯èƒ½éæ–°ç”¨æˆ·ï¼ˆéœ€æ¢å¤æ•°æ®ï¼‰
5. æ‰€æœ‰æ¡ä»¶éƒ½ä¸æ»¡è¶³ â†’ çœŸæ­£çš„æ–°ç”¨æˆ·
```

### 2. è‡ªåŠ¨æ•°æ®æ¢å¤

**è§¦å‘æ—¶æœºï¼š**
- ç”¨æˆ·ç™»å½•æ—¶è‡ªåŠ¨æ£€æŸ¥
- æ£€æµ‹åˆ°æ•°æ®ä¸ä¸€è‡´æ—¶ç«‹å³æ¢å¤

**æ¢å¤æµç¨‹ï¼š**
```
1. æ£€æµ‹æ•°æ®å¼‚å¸¸ï¼ˆlocalStorage ä¸ºç©ºä½†æ•°æ®åº“æœ‰æ•°æ®ï¼‰
   â†“
2. ä»æ•°æ®åº“è·å–ç”¨æˆ·æ•°æ®
   â†“
3. æ¢å¤åˆ° localStorage
   - userExpï¼ˆç”¨æˆ·ç»éªŒï¼‰
   - achievedAchievementsï¼ˆå·²è§£é”æˆå°±ï¼‰
   - totalFocusMinutesï¼ˆç´¯è®¡ä¸“æ³¨æ—¶é•¿ï¼‰
   â†“
4. è®¾ç½®æ¢å¤æ ‡è®°
   â†“
5. é€šçŸ¥ç”¨æˆ·ï¼ˆå¯é€‰ï¼‰
```

### 3. é˜²æŠ¤æ ‡è®°ç³»ç»Ÿ

**ç›®çš„ï¼š** å³ä½¿ localStorage è¢«æ¸…é™¤ï¼Œä¹Ÿèƒ½é€šè¿‡å…³é”®é‡Œç¨‹ç¢‘æ ‡è®°è¯†åˆ«éæ–°ç”¨æˆ·

**æ ‡è®°ç±»å‹ï¼š**

| æ ‡è®°ç±»å‹ | è§¦å‘æ—¶æœº | ç”¨é€” |
|---------|---------|------|
| `protection_first_focus` | é¦–æ¬¡å®Œæˆä¸“æ³¨ | è¯æ˜ç”¨æˆ·å®Œæˆè¿‡ä¸“æ³¨ |
| `protection_first_achievement` | é¦–æ¬¡è§£é”æˆå°± | è¯æ˜ç”¨æˆ·æœ‰æˆå°±è®°å½• |
| `protection_exp_milestone` | æ¯è¾¾åˆ° 100 EXP | è¯æ˜ç”¨æˆ·æœ‰ç»éªŒç§¯ç´¯ |

### 4. æˆå°±ç³»ç»Ÿæ•°æ®åº“åŒæ­¥

**æ”¹è¿›å‰ï¼š**
```typescript
// åªä» localStorage è¯»å–
const stored = localStorage.getItem('achievedAchievements');
this.achievedAchievements = new Set(JSON.parse(stored));
```

**æ”¹è¿›åï¼š**
```typescript
// 1. å…ˆä» localStorage è¯»å–
this.loadAchievedAchievements();

// 2. å†ä»æ•°æ®åº“åŒæ­¥
await manager.syncFromDatabase();

// 3. å¦‚æœæ•°æ®åº“æœ‰æ›´å¤šæˆå°±ï¼Œä½¿ç”¨æ•°æ®åº“æ•°æ®
if (dbAchievements.size > localAchievements.size) {
  this.achievedAchievements = dbAchievements;
  this.saveAchievedAchievements();
}
```

## ğŸ“‚ æ ¸å¿ƒæ–‡ä»¶

### 1. `src/lib/DataIntegritySystem.ts`

**åŠŸèƒ½ï¼š**
- æ–°ç”¨æˆ·åˆ¤å®š `isReallyNewUser()`
- æ•°æ®æ¢å¤ `recoverDataFromDatabase()`
- æ•°æ®å®Œæ•´æ€§æ£€æŸ¥ `checkDataIntegrity()`
- é˜²æŠ¤æ ‡è®° `setProtectionMarker()` / `hasProtectionMarker()`

### 2. `src/lib/AchievementSystem.tsx`

**æ”¹è¿›ï¼š**
- æ–°å¢ `syncFromDatabase()` æ–¹æ³•
- å¯åŠ¨æ—¶è‡ªåŠ¨ä»æ•°æ®åº“åŒæ­¥æˆå°±æ•°æ®
- æ£€æµ‹å¹¶ä¿®å¤æ•°æ®ä¸ä¸€è‡´

### 3. `src/hooks/useUserExp.ts`

**æ”¹è¿›ï¼š**
- é›†æˆé˜²æŠ¤æ ‡è®°ç³»ç»Ÿ
- æ¯è¾¾åˆ° 100 EXP è®¾ç½®é‡Œç¨‹ç¢‘æ ‡è®°

### 4. `src/components/DataRecoveryAlert.tsx`

**åŠŸèƒ½ï¼š**
- ç”¨æˆ·å‹å¥½çš„æ•°æ®æ¢å¤ç•Œé¢
- ä¸€é”®æ¢å¤äº‘ç«¯æ•°æ®
- æ˜¾ç¤ºæ¢å¤çŠ¶æ€å’Œè¿›åº¦

## ğŸ”„ æ•°æ®æµ

### ç™»å½•æ—¶çš„æ•°æ®æµï¼š

```
ç”¨æˆ·ç™»å½•
  â†“
1. æ£€æŸ¥ localStorage æ•°æ®
  â†“
2. æ£€æŸ¥æ•°æ®åº“æ•°æ®
  â†“
3. åˆ¤æ–­æ•°æ®ä¸€è‡´æ€§
  â”œâ”€ ä¸€è‡´ â†’ æ­£å¸¸ä½¿ç”¨
  â””â”€ ä¸ä¸€è‡´
      â†“
      a. æ•°æ®åº“æœ‰æ•°æ®ï¼ŒlocalStorage æ— æ•°æ®
         â†’ è‡ªåŠ¨ä»æ•°æ®åº“æ¢å¤
      â†“
      b. localStorage æœ‰æ•°æ®ï¼Œæ•°æ®åº“æ— æ•°æ®
         â†’ åŒæ­¥åˆ°æ•°æ®åº“
      â†“
      c. ä¸¤è€…éƒ½æœ‰ä½†ä¸ä¸€è‡´
         â†’ ä½¿ç”¨æ•°æ®åº“æ•°æ®ï¼ˆæƒå¨æ•°æ®æºï¼‰
```

### æ•°æ®æ›´æ–°æ—¶çš„ä¿æŠ¤æµç¨‹ï¼š

```
ç”¨æˆ·å®Œæˆä¸“æ³¨/è§£é”æˆå°±
  â†“
1. æ›´æ–° localStorageï¼ˆç«‹å³ç”Ÿæ•ˆï¼‰
  â†“
2. åŒæ­¥åˆ°æ•°æ®åº“ï¼ˆåå°è¿›è¡Œï¼‰
  â†“
3. è®¾ç½®é˜²æŠ¤æ ‡è®°ï¼ˆå…³é”®é‡Œç¨‹ç¢‘ï¼‰
  â†“
4. åŒé‡ä¿æŠ¤å®Œæˆ
```

## ğŸ›¡ï¸ é˜²æŠ¤å±‚çº§

### ç¬¬ä¸€å±‚ï¼šlocalStorageï¼ˆå¿«é€Ÿè®¿é—®ï¼‰
- ç”¨æˆ·ä½“éªŒä¼˜å…ˆ
- ç«‹å³ç”Ÿæ•ˆ
- å¯èƒ½è¢«æ¸…é™¤

### ç¬¬äºŒå±‚ï¼šæ•°æ®åº“ï¼ˆæƒå¨æ•°æ®ï¼‰
- æŒä¹…åŒ–å­˜å‚¨
- è·¨è®¾å¤‡åŒæ­¥
- å¯é ä½†è¾ƒæ…¢

### ç¬¬ä¸‰å±‚ï¼šé˜²æŠ¤æ ‡è®°ï¼ˆå¤‡ç”¨éªŒè¯ï¼‰
- å…³é”®é‡Œç¨‹ç¢‘æ ‡è®°
- å³ä½¿æ•°æ®ä¸¢å¤±ä¹Ÿèƒ½è¯†åˆ«
- é˜²æ­¢è¯¯åˆ¤æ–°ç”¨æˆ·

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### å¯¹äºå¼€å‘è€…ï¼š

#### 1. å¯åŠ¨æ—¶æ£€æŸ¥æ•°æ®å®Œæ•´æ€§

```typescript
// åœ¨ dashboard ç»„ä»¶ä¸­
useEffect(() => {
  if (session?.user?.id) {
    // æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
    checkDataIntegrity(session.user.id);
    
    // æˆå°±æ•°æ®åŒæ­¥
    const manager = getAchievementManager();
    await manager.syncFromDatabase();
  }
}, [session?.user?.id]);
```

#### 2. å…³é”®æ“ä½œæ—¶è®¾ç½®é˜²æŠ¤æ ‡è®°

```typescript
// å®Œæˆé¦–æ¬¡ä¸“æ³¨æ—¶
if (firstFocusAchievement.length > 0) {
  setProtectionMarker('first_focus');
}

// è§£é”æˆå°±æ—¶
if (newAchievements.length > 0) {
  setProtectionMarker('first_achievement');
}

// è¾¾åˆ°ç»éªŒé‡Œç¨‹ç¢‘æ—¶
if (newExp >= 100) {
  setProtectionMarker('exp_milestone');
}
```

#### 3. æ‰‹åŠ¨è§¦å‘æ•°æ®æ¢å¤ï¼ˆå¯é€‰ï¼‰

```typescript
import { recoverDataFromDatabase } from '~/lib/DataIntegritySystem';

// ç”¨æˆ·ç‚¹å‡»"æ¢å¤æ•°æ®"æŒ‰é’®
const handleRecover = async () => {
  const success = await recoverDataFromDatabase();
  if (success) {
    window.location.reload(); // åˆ·æ–°é¡µé¢åº”ç”¨æ–°æ•°æ®
  }
};
```

### å¯¹äºç”¨æˆ·ï¼š

#### 1. è‡ªåŠ¨ä¿æŠ¤ï¼ˆæ— éœ€æ“ä½œï¼‰
ç³»ç»Ÿä¼šåœ¨åå°è‡ªåŠ¨ï¼š
- âœ… æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
- âœ… ä»äº‘ç«¯æ¢å¤æ•°æ®
- âœ… åŒæ­¥æˆå°±å’Œç»éªŒå€¼

#### 2. æ‰‹åŠ¨æ¢å¤ï¼ˆå¦‚æœéœ€è¦ï¼‰
å¦‚æœé‡åˆ°æ•°æ®å¼‚å¸¸ï¼š
1. ç³»ç»Ÿä¼šæ˜¾ç¤º"æ•°æ®æ¢å¤æç¤º"
2. ç‚¹å‡»"æ¢å¤æ•°æ®"æŒ‰é’®
3. ç­‰å¾…æ•°æ®ä»äº‘ç«¯æ¢å¤
4. é¡µé¢è‡ªåŠ¨åˆ·æ–°

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šç”¨æˆ·åé¦ˆæ•°æ®ä¸¢å¤±

**æ£€æŸ¥æ­¥éª¤ï¼š**

1. **æ£€æŸ¥ localStorage**
```javascript
// æµè§ˆå™¨æ§åˆ¶å°
console.log('userExp:', localStorage.getItem('userExp'));
console.log('achievements:', localStorage.getItem('achievedAchievements'));
console.log('protection markers:', 
  localStorage.getItem('protection_first_focus'),
  localStorage.getItem('protection_first_achievement')
);
```

2. **æ£€æŸ¥æ•°æ®åº“**
```bash
# è¿è¡Œè¯Šæ–­è„šæœ¬
npx tsx scripts/check-data-integrity.ts user@example.com
```

3. **æ‰‹åŠ¨æ¢å¤æ•°æ®**
```typescript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°
import { recoverDataFromDatabase } from '~/lib/DataIntegritySystem';
await recoverDataFromDatabase();
```

### é—®é¢˜ï¼šæˆå°±é‡å¤è§£é”

**åŸå› ï¼š** æˆå°±æ•°æ®æœªæ­£ç¡®åŒæ­¥

**è§£å†³ï¼š**
```typescript
// åœ¨ dashboard ç»„ä»¶æŒ‚è½½æ—¶
const manager = getAchievementManager();
await manager.syncFromDatabase(); // ç¡®ä¿ä»æ•°æ®åº“åŒæ­¥
```

### é—®é¢˜ï¼šç³»ç»Ÿè¯¯åˆ¤ä¸ºæ–°ç”¨æˆ·

**åŸå› ï¼š** æ‰€æœ‰æ•°æ®éƒ½è¢«æ¸…é™¤

**è§£å†³ï¼š**
1. æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦æœ‰ç”¨æˆ·ä¸“æ³¨è®°å½•
2. å¦‚æœæœ‰ï¼Œè¿è¡Œæ•°æ®æ¢å¤
3. å¦‚æœæ²¡æœ‰ï¼Œå¯èƒ½æ˜¯çœŸçš„æ–°ç”¨æˆ·æˆ–æ•°æ®å·²æ°¸ä¹…ä¸¢å¤±

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

å»ºè®®ç›‘æ§ä»¥ä¸‹æŒ‡æ ‡ï¼š

| æŒ‡æ ‡ | æè¿° | æ­£å¸¸å€¼ |
|-----|------|--------|
| æ•°æ®æ¢å¤è§¦å‘ç‡ | éœ€è¦æ¢å¤æ•°æ®çš„ç”¨æˆ·æ¯”ä¾‹ | < 5% |
| æ¢å¤æˆåŠŸç‡ | æˆåŠŸæ¢å¤æ•°æ®çš„æ¯”ä¾‹ | > 95% |
| localStorage æ¸…é™¤ç‡ | localStorage è¢«æ¸…é™¤çš„é¢‘ç‡ | < 10% |
| è¯¯åˆ¤æ–°ç”¨æˆ·ç‡ | è€ç”¨æˆ·è¢«è¯¯åˆ¤ä¸ºæ–°ç”¨æˆ·çš„æ¯”ä¾‹ | < 1% |

## âš¡ æ€§èƒ½ä¼˜åŒ–

1. **æ‡’åŠ è½½æ•°æ®åº“åŒæ­¥**
   - åªåœ¨å¿…è¦æ—¶æ‰ä»æ•°æ®åº“åŒæ­¥
   - ä½¿ç”¨æ ‡è®°é¿å…é‡å¤åŒæ­¥

2. **å¹¶å‘è¯·æ±‚**
   - åŒæ—¶è¯·æ±‚ç”¨æˆ·æ•°æ®ã€æˆå°±æ•°æ®ã€ä¸“æ³¨è®°å½•
   - å‡å°‘ç­‰å¾…æ—¶é—´

3. **ç¼“å­˜ç­–ç•¥**
   - æ•°æ®åº“æ•°æ®åœ¨ä¼šè¯æœŸé—´ç¼“å­˜
   - å‡å°‘é‡å¤è¯·æ±‚

## ğŸ” å®‰å…¨æ€§

1. **æ•°æ®éªŒè¯**
   - ä»æ•°æ®åº“æ¢å¤çš„æ•°æ®éœ€è¦éªŒè¯æ ¼å¼
   - é˜²æ­¢æ¶æ„æ•°æ®æ³¨å…¥

2. **æƒé™æ£€æŸ¥**
   - åªèƒ½æ¢å¤å½“å‰ç™»å½•ç”¨æˆ·çš„æ•°æ®
   - ä½¿ç”¨ session éªŒè¯èº«ä»½

3. **æ“ä½œæ—¥å¿—**
   - è®°å½•æ‰€æœ‰æ•°æ®æ¢å¤æ“ä½œ
   - ä¾¿äºå®¡è®¡å’Œæ’æŸ¥é—®é¢˜

## ğŸ“ æ€»ç»“

**æ ¸å¿ƒæ”¹è¿›ï¼š**
1. âœ… åŒé‡éªŒè¯ï¼šlocalStorage + æ•°æ®åº“
2. âœ… è‡ªåŠ¨æ¢å¤ï¼šæ£€æµ‹å¼‚å¸¸ç«‹å³æ¢å¤
3. âœ… é˜²æŠ¤æ ‡è®°ï¼šé˜²æ­¢è¯¯åˆ¤æ–°ç”¨æˆ·
4. âœ… æ•°æ®åŒæ­¥ï¼šæˆå°±ç³»ç»Ÿæ”¯æŒæ•°æ®åº“åŒæ­¥
5. âœ… ç”¨æˆ·å‹å¥½ï¼šæä¾›å¯è§†åŒ–æ¢å¤ç•Œé¢

**æ•ˆæœï¼š**
- ğŸ¯ å½»åº•è§£å†³æ•°æ®ä¸¢å¤±é—®é¢˜
- ğŸ¯ å‡†ç¡®åˆ¤æ–­æ–°è€ç”¨æˆ·
- ğŸ¯ ç”¨æˆ·æ— æ„ŸçŸ¥è‡ªåŠ¨æ¢å¤
- ğŸ¯ å¤šå±‚é˜²æŠ¤æœºåˆ¶ä¿éšœæ•°æ®å®‰å…¨

---

**æœ€åæ›´æ–°ï¼š** 2024-12-19  
**ç‰ˆæœ¬ï¼š** 1.0.0

