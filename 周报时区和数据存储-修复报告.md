# ğŸ“… å‘¨æŠ¥æ—¶åŒºå’Œæ•°æ®å­˜å‚¨ - å®Œæ•´ä¿®å¤æŠ¥å‘Š

## ğŸ¯ ä¿®å¤ç›®æ ‡

1. **ç¡®ä¿7å¤©æ•°æ®å®Œæ•´ä¿å­˜**ï¼šå‘¨æŠ¥å†…çš„ä¸“æ³¨æ—¶é•¿å’Œå¿ƒæµæ•°æ®éƒ½èƒ½æ­£ç¡®æ˜¾ç¤º
2. **ä¿®å¤æ—¶åŒºé—®é¢˜**ï¼šä½¿ç”¨ç”¨æˆ·æœ¬åœ°æ—¶åŒºï¼Œè€Œä¸æ˜¯ UTC
3. **ç¡®è®¤æ—¥æœŸåŒºé—´**ï¼šç¡®ä¿å‘¨æŠ¥æ˜¾ç¤ºçš„æ˜¯æ­£ç¡®çš„å‘¨æœŸï¼ˆä¾‹å¦‚ï¼š12/15-12/21ï¼‰
4. **é‚®ç®±å’Œå‘¨æŠ¥ä¸€è‡´**ï¼šé‚®ç®±ç³»ç»Ÿå’Œå‘¨æŠ¥é¡µé¢æ˜¾ç¤ºç›¸åŒçš„æ—¥æœŸåŒºé—´

---

## ğŸ” å‘ç°çš„é—®é¢˜

### é—®é¢˜ 1ï¼šæ—¶åŒºå¤„ç†é”™è¯¯ âŒ

**åŸä»£ç **ï¼ˆ`src/lib/weeklyReport.ts:404-408`ï¼‰ï¼š
```typescript
// âŒ é—®é¢˜ä»£ç 
export function formatDateKey(date: Date) {
  const local = new Date(date);
  local.setHours(0, 0, 0, 0);
  return local.toISOString().slice(0, 10);  // âŒ toISOString() ä½¿ç”¨ UTC æ—¶åŒº
}
```

**é—®é¢˜åˆ†æ**ï¼š
- `toISOString()` ä¼šå°†æ—¥æœŸè½¬æ¢ä¸º UTC æ—¶åŒº
- å¯¹äºä¸œå…«åŒºï¼ˆUTC+8ï¼‰çš„ç”¨æˆ·ï¼š
  ```
  æœ¬åœ°æ—¶é—´ï¼š2025-12-23 00:00:00
  UTC æ—¶é—´ï¼š2025-12-22 16:00:00
  toISOString()ï¼š2025-12-22  â† æ—¥æœŸé”™è¯¯ï¼
  ```
- å¯¼è‡´æ—¥æœŸåç§»ä¸€å¤©

### é—®é¢˜ 2ï¼šæ•°æ®å­˜å‚¨ä¸è¶³ âŒ

**åŸé…ç½®**ï¼š
- DailySummary åªä¿ç•™ 8 æ¡
- å‘¨æŠ¥æŸ¥è¯¢ä¹Ÿåªå– 8 æ¡

**é—®é¢˜**ï¼š
- ä¸Šå‘¨7å¤© + æœ¬å‘¨7å¤© = 14å¤©
- ä½†åªä¿å­˜8å¤©çš„æ•°æ®
- å¯¼è‡´ä¸Šå‘¨çš„æ•°æ®å¯èƒ½è¢«åˆ é™¤

### é—®é¢˜ 3ï¼šå‘¨æœŸè®¡ç®—ä¸æ¸…æ™° âŒ

**åŸä»£ç **ï¼š
```typescript
const end = new Date(start);
end.setDate(start.getDate() + 7);  // âŒ å‘¨ä¸€+7å¤© = ä¸‹å‘¨ä¸€
end.setMilliseconds(-1);
```

**é—®é¢˜**ï¼š
- å‘¨ä¸€ + 7å¤© = ä¸‹å‘¨ä¸€ï¼ˆä¸æ˜¯å‘¨æ—¥ï¼‰
- åº”è¯¥æ˜¯ å‘¨ä¸€ + 6å¤© = å‘¨æ—¥

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1ï¼šæ—¶åŒºå¤„ç† âœ…

**ä¿®æ”¹æ–‡ä»¶**ï¼š`src/lib/weeklyReport.ts`

**æ–°ä»£ç **ï¼š
```typescript
export function formatDateKey(date: Date) {
  // âœ… ä½¿ç”¨ç”¨æˆ·æœ¬åœ°æ—¶åŒºï¼Œè€Œä¸æ˜¯ UTC
  const local = new Date(date);
  const year = local.getFullYear();
  const month = String(local.getMonth() + 1).padStart(2, '0');
  const day = String(local.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}
```

**æ•ˆæœ**ï¼š
```
æœ¬åœ°æ—¶é—´ï¼š2025-12-23 00:00:00
formatDateKey()ï¼š2025-12-23  âœ… æ­£ç¡®ï¼
```

---

### ä¿®å¤ 2ï¼šå¢åŠ æ•°æ®å­˜å‚¨ âœ…

**ä¿®æ”¹æ–‡ä»¶**ï¼š
1. `src/lib/weeklyReport.ts` (ç¬¬113-117è¡Œ)
2. `src/pages/api/daily-summary/today.ts` (ç¬¬128-133è¡Œ)

**ä¿®æ”¹å†…å®¹**ï¼š
```typescript
// âœ… ä» 8 æ¡å¢åŠ åˆ° 10 æ¡
db.dailySummary.findMany({
  where: { userId },
  orderBy: { date: "desc" },
  take: 10,  // âœ… ç¡®ä¿ä¸Šå‘¨æ•°æ®èƒ½å®Œæ•´ä¿å­˜
  select: { date: true, text: true },
})

// æ¸…ç†æ—¶ä¹Ÿä¿ç•™ 10 æ¡
skip: 10,  // âœ… ä¿ç•™æœ€è¿‘ 10 æ¡
```

**æ•°æ®è¦†ç›–èŒƒå›´**ï¼š
```
10 æ¡æ•°æ® = 10 å¤©
æœ¬å‘¨ 7 å¤© + ä¸Šå‘¨ 3 å¤© = å¯ä»¥è¦†ç›–
å®é™…ä¸Šå¯ä»¥ä¿å­˜æ›´å¤šå†å²æ•°æ®
```

---

### ä¿®å¤ 3ï¼šå‘¨æœŸè®¡ç®—ä¼˜åŒ– âœ…

**ä¿®æ”¹æ–‡ä»¶**ï¼š`src/lib/weeklyReport.ts`

**æ–°ä»£ç **ï¼š
```typescript
export function getWeekRange(referenceDate = new Date()) {
  const ref = new Date(referenceDate);
  ref.setHours(0, 0, 0, 0);
  const day = ref.getDay();
  const mondayOffset = day === 0 ? -6 : 1 - day;
  
  // å‘¨ä¸€ 00:00:00
  const start = new Date(ref);
  start.setDate(ref.getDate() + mondayOffset);
  start.setHours(0, 0, 0, 0);

  // å‘¨æ—¥ 23:59:59.999ï¼ˆä»å‘¨ä¸€å¼€å§‹+6å¤©ï¼‰âœ…
  const end = new Date(start);
  end.setDate(start.getDate() + 6);  // âœ… +6å¤© = å‘¨æ—¥
  end.setHours(23, 59, 59, 999);

  // âœ… è¯¦ç»†æ—¥å¿—
  console.log(`[getWeekRange] ğŸ“… å‘¨æœŸè®¡ç®—:`, {
    å‚è€ƒæ—¥æœŸ: formatDateKey(ref),
    å‘¨ä¸€: formatDateKey(start),
    å‘¨æ—¥: formatDateKey(end),
    æ ‡ç­¾: formatLabel(start, end),
  });

  return { start, end };
}
```

---

### ä¿®å¤ 4ï¼šè¯¦ç»†æ—¥å¿— âœ…

**ä¿®æ”¹æ–‡ä»¶**ï¼š
1. `src/lib/weeklyReport.ts` - å‘¨æŠ¥ç”Ÿæˆæ—¥å¿—
2. `src/pages/api/generate-weekly-mail.ts` - API æ—¥å¿—

**æ–°å¢æ—¥å¿—**ï¼š
```typescript
console.log(`[computeWeeklyReport] ==================== å‘¨æŠ¥æ•°æ®ç”Ÿæˆ ====================`);
console.log(`[computeWeeklyReport] ç”¨æˆ·ID: ${userId}`);
console.log(`[computeWeeklyReport] ğŸ“… å‘¨æœŸèŒƒå›´ï¼ˆç”¨æˆ·æœ¬åœ°æ—¶åŒºï¼‰:`);
console.log(`[computeWeeklyReport]    å¼€å§‹: ${formatDateKey(weekStart)} (å‘¨ä¸€)`);
console.log(`[computeWeeklyReport]    ç»“æŸ: ${formatDateKey(weekEnd)} (å‘¨æ—¥)`);
console.log(`[computeWeeklyReport]    æ ‡ç­¾: ${formatLabel(weekStart, weekEnd)}`);
console.log(`[computeWeeklyReport] ğŸ“Š æ•°æ®ç»Ÿè®¡:`);
console.log(`[computeWeeklyReport]    æœ¬å‘¨ä¸“æ³¨è®°å½•: ${sessions.length} æ¡`);
console.log(`[computeWeeklyReport]    æ¯æ—¥å°ç»“: ${summaries.length} æ¡`);
console.log(`[computeWeeklyReport] ğŸ“† 7å¤©æ—¥æœŸåˆ—è¡¨:`, weekDates);

// æ¯æ—¥æ•°æ®è¯¦æƒ…
daily.forEach(day => {
  if (day.minutes > 0 || day.flowIndex !== null) {
    console.log(`[computeWeeklyReport]    ${day.date}: ${day.minutes}åˆ†é’Ÿ, å¿ƒæµ${day.flowIndex || 'N/A'}`);
  }
});
```

---

## ğŸ§ª éªŒè¯å·¥å…·

### å·¥å…·ï¼šCHECK_TIMEZONE_AND_DATES.js

æˆ‘åˆ›å»ºäº†ä¸€ä¸ªä¸“é—¨çš„æ—¶åŒºå’Œæ—¥æœŸç¡®è®¤å·¥å…·ã€‚

**åŠŸèƒ½**ï¼š
1. `checkTimezone()` - æŸ¥çœ‹ç”¨æˆ·æ—¶åŒºä¿¡æ¯
2. `checkWeekDates()` - æŸ¥çœ‹æœ¬å‘¨å’Œä¸Šå‘¨çš„æ—¥æœŸåŒºé—´
3. `checkMailboxDates()` - æŸ¥çœ‹ä¿¡ç®±ä¸­å‘¨æŠ¥çš„æ—¥æœŸ
4. `generateTestWeeklyMail()` - ç”Ÿæˆæµ‹è¯•å‘¨æŠ¥

**ä½¿ç”¨æ–¹æ³•**ï¼š
```javascript
// 1. æ‰“å¼€ Dashboard
// 2. æŒ‰ F12 æ‰“å¼€æ§åˆ¶å°
// 3. å¤åˆ¶ç²˜è´´ CHECK_TIMEZONE_AND_DATES.js çš„å…¨éƒ¨å†…å®¹
// 4. è¿è¡Œæ£€æŸ¥å‘½ä»¤

checkTimezone();      // æŸ¥çœ‹æ—¶åŒº
checkWeekDates();     // æŸ¥çœ‹æ—¥æœŸåŒºé—´
generateTestWeeklyMail();  // ç”Ÿæˆæµ‹è¯•å‘¨æŠ¥
checkMailboxDates();  // æŸ¥çœ‹ä¿¡ç®±æ—¥æœŸ
```

---

## ğŸ“Š æ—¥æœŸåŒºé—´éªŒè¯

### ç¤ºä¾‹ï¼šä»Šå¤©æ˜¯ 2025-12-23ï¼ˆå‘¨äºŒï¼‰

**æœ¬å‘¨**ï¼š
- å‘¨ä¸€ï¼š2025-12-23 â†’ âŒ é”™è¯¯ï¼å‘¨äºŒä¸æ˜¯å‘¨ä¸€
- æ­£ç¡®è®¡ç®—ï¼š
  ```
  ä»Šå¤©ï¼š2025-12-23ï¼ˆå‘¨äºŒï¼‰
  æœ¬å‘¨ä¸€ï¼š2025-12-23 - 1 = 2025-12-22ï¼ˆå‘¨ä¸€ï¼‰âœ…
  æœ¬å‘¨æ—¥ï¼š2025-12-22 + 6 = 2025-12-28ï¼ˆå‘¨æ—¥ï¼‰âœ…
  æœ¬å‘¨ï¼š12/22 - 12/28 âœ…
  ```

**ä¸Šå‘¨**ï¼š
- ä¸Šå‘¨ä¸€ï¼š2025-12-22 - 7 = 2025-12-15ï¼ˆå‘¨ä¸€ï¼‰âœ…
- ä¸Šå‘¨æ—¥ï¼š2025-12-15 + 6 = 2025-12-21ï¼ˆå‘¨æ—¥ï¼‰âœ…
- ä¸Šå‘¨ï¼š12/15 - 12/21 âœ…

**éªŒè¯æ–¹æ³•**ï¼š
```javascript
// åœ¨æ§åˆ¶å°è¿è¡Œ
checkWeekDates();

// è¾“å‡ºåº”è¯¥æ˜¾ç¤ºï¼š
// æœ¬å‘¨ï¼š2025-12-22 è‡³ 2025-12-28
// ä¸Šå‘¨ï¼š2025-12-15 è‡³ 2025-12-21
```

---

## ğŸ” æ•°æ®å®Œæ•´æ€§éªŒè¯

### 7å¤©æ•°æ®å­˜å‚¨

**æ•°æ®åº“æŸ¥è¯¢**ï¼š
```typescript
// æŸ¥è¯¢æœ¬å‘¨çš„ä¸“æ³¨è®°å½•
db.focusSession.findMany({
  where: { 
    userId, 
    startTime: { 
      gte: weekStart,  // 2025-12-15 00:00:00
      lte: weekEnd     // 2025-12-21 23:59:59
    } 
  }
})

// æŸ¥è¯¢æœ¬å‘¨çš„æ¯æ—¥å°ç»“ï¼ˆæœ€å¤š10æ¡ï¼‰
db.dailySummary.findMany({
  where: { 
    userId, 
    date: { in: weekDates }  // ['2025-12-15', '2025-12-16', ..., '2025-12-21']
  }
})
```

**ç”Ÿæˆ7å¤©æ•°æ®**ï¼š
```typescript
const weekDates = getWeekDates(weekStart);
// ['2025-12-15', '2025-12-16', '2025-12-17', '2025-12-18', 
//  '2025-12-19', '2025-12-20', '2025-12-21']

const daily = weekDates.map((date) => {
  const daySessions = sessions.filter(
    (s) => formatDateKey(s.startTime) === date
  );
  const minutes = daySessions.reduce((sum, s) => sum + s.duration, 0);
  const flowAvg = /* è®¡ç®—å¹³å‡å¿ƒæµ */;
  
  return {
    date,           // âœ… æ—¥æœŸ
    minutes,        // âœ… ä¸“æ³¨æ—¶é•¿
    flowIndex,      // âœ… å¿ƒæµæŒ‡æ•°
    note            // âœ… æ¯æ—¥å°ç»“
  };
});
```

**ç»“æœ**ï¼š
- âœ… 7å¤©çš„æ•°æ®éƒ½ä¼šè¢«ç”Ÿæˆ
- âœ… ä¸“æ³¨æ—¶é•¿ä» FocusSession è®¡ç®—
- âœ… å¿ƒæµæŒ‡æ•°ä» FocusSession.flowIndex æˆ– rating è®¡ç®—
- âœ… æ¯æ—¥å°ç»“ä» DailySummary è·å–

---

## ğŸ§ª å®Œæ•´æµ‹è¯•æµç¨‹

### æ­¥éª¤ 1ï¼šç¡®è®¤æ—¶åŒºå’Œæ—¥æœŸ

åœ¨æ§åˆ¶å°è¿è¡Œï¼š
```javascript
// åŠ è½½å·¥å…·
// å¤åˆ¶ç²˜è´´ CHECK_TIMEZONE_AND_DATES.js

// æ£€æŸ¥æ—¶åŒº
checkTimezone();

// è¾“å‡ºç¤ºä¾‹ï¼š
// ğŸ“… å½“å‰æ—¶é—´:
//    æœ¬åœ°æ—¶é—´: 2025/12/23 14:30:00
//    UTC æ—¶é—´: 2025-12-23T06:30:00.000Z
//    æ—¶åŒºåç§»: -480 åˆ†é’Ÿï¼ˆUTC+8ï¼‰
//    æ—¶åŒºåç§°: Asia/Shanghai

// æ£€æŸ¥å‘¨æœŸ
checkWeekDates();

// è¾“å‡ºç¤ºä¾‹ï¼š
// ğŸ“Š æœ¬å‘¨ï¼ˆå½“å‰å‘¨ï¼‰:
//    å¼€å§‹: 2025-12-22 (å‘¨ä¸€)
//    ç»“æŸ: 2025-12-28 (å‘¨æ—¥)
//    æ ‡ç­¾: 12/22 - 12/28
//    7å¤©: 2025-12-22, 2025-12-23, ..., 2025-12-28
//
// ğŸ“Š ä¸Šå‘¨:
//    å¼€å§‹: 2025-12-15 (å‘¨ä¸€)
//    ç»“æŸ: 2025-12-21 (å‘¨æ—¥)
//    æ ‡ç­¾: 12/15 - 12/21
//    7å¤©: 2025-12-15, 2025-12-16, ..., 2025-12-21
```

**éªŒè¯**ï¼š
- âœ… ç¡®è®¤"ä¸Šå‘¨"æ˜¯å¦æ˜¯ 12/15-12/21
- âœ… ç¡®è®¤7å¤©æ—¥æœŸåˆ—è¡¨å®Œæ•´

---

### æ­¥éª¤ 2ï¼šç”Ÿæˆæµ‹è¯•å‘¨æŠ¥

åœ¨æ§åˆ¶å°è¿è¡Œï¼š
```javascript
generateTestWeeklyMail();

// è¾“å‡ºç¤ºä¾‹ï¼š
// ğŸ§ª ç”Ÿæˆæµ‹è¯•å‘¨æŠ¥é‚®ä»¶
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸ“… å‡†å¤‡ç”Ÿæˆå‘¨æŠ¥:
//    ä¸Šå‘¨ä¸€æ—¥æœŸ: 2025-12-15
// 
// æ­£åœ¨è¯·æ±‚ API...
// 
// [generate-weekly-mail] ç”Ÿæˆå‘¨æŠ¥: userId=xxx, week=2025-12-15 to 2025-12-21
// [getWeekRange] ğŸ“… å‘¨æœŸè®¡ç®—: {
//   å‚è€ƒæ—¥æœŸ: '2025-12-15',
//   å‘¨ä¸€: '2025-12-15',
//   å‘¨æ—¥: '2025-12-21',
//   æ ‡ç­¾: '12/15 - 12/21'
// }
// [computeWeeklyReport] ==================== å‘¨æŠ¥æ•°æ®ç”Ÿæˆ ====================
// [computeWeeklyReport] ç”¨æˆ·ID: xxx
// [computeWeeklyReport] ğŸ“… å‘¨æœŸèŒƒå›´ï¼ˆç”¨æˆ·æœ¬åœ°æ—¶åŒºï¼‰:
// [computeWeeklyReport]    å¼€å§‹: 2025-12-15 (å‘¨ä¸€)
// [computeWeeklyReport]    ç»“æŸ: 2025-12-21 (å‘¨æ—¥)
// [computeWeeklyReport]    æ ‡ç­¾: 12/15 - 12/21
// [computeWeeklyReport] ğŸ“Š æ•°æ®ç»Ÿè®¡:
// [computeWeeklyReport]    æœ¬å‘¨ä¸“æ³¨è®°å½•: 10 æ¡
// [computeWeeklyReport]    æ¯æ—¥å°ç»“: 7 æ¡
// [computeWeeklyReport] ğŸ“† 7å¤©æ—¥æœŸåˆ—è¡¨: [
//   '2025-12-15', '2025-12-16', '2025-12-17', '2025-12-18',
//   '2025-12-19', '2025-12-20', '2025-12-21'
// ]
// [computeWeeklyReport]    2025-12-15: 60åˆ†é’Ÿ, å¿ƒæµ75
// [computeWeeklyReport]    2025-12-16: 45åˆ†é’Ÿ, å¿ƒæµ80
// [computeWeeklyReport]    2025-12-17: 30åˆ†é’Ÿ, å¿ƒæµ70
// ... (7å¤©æ•°æ®)
// [computeWeeklyReport] ========================================================
// 
// âœ… å‘¨æŠ¥ç”ŸæˆæˆåŠŸï¼
// ğŸ“Š å‘¨æŠ¥ä¿¡æ¯:
//    æ ‡é¢˜: æœ¬å‘¨ä¸“æ³¨å‘¨æŠ¥ Â· 12/15 - 12/21
//    æŸ¥çœ‹é“¾æ¥: /reports/weekly?weekStart=2025-12-15
// ğŸ“ˆ æ•°æ®æ‘˜è¦:
//    æ€»æ—¶é•¿: 300 åˆ†é’Ÿ
//    è¿ç»­å¤©æ•°: 5 å¤©
//    å¿ƒæµæŒ‡æ•°: 75
// 
// âœ… é‚®ä»¶å·²æ·»åŠ åˆ°ä¿¡ç®±
```

---

### æ­¥éª¤ 3ï¼šéªŒè¯é‚®ç®±æ—¥æœŸ

åœ¨æ§åˆ¶å°è¿è¡Œï¼š
```javascript
checkMailboxDates();

// è¾“å‡ºç¤ºä¾‹ï¼š
// ğŸ“§ ä¿¡ç®±ä¸­çš„å‘¨æŠ¥é‚®ä»¶æ—¥æœŸ
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// å…±æœ‰ 1 å°å‘¨æŠ¥é‚®ä»¶ï¼š
// 
// 1. æœ¬å‘¨ä¸“æ³¨å‘¨æŠ¥ Â· 12/15 - 12/21
//    é‚®ä»¶æ—¥æœŸ: 2025-12-23
//    æŸ¥çœ‹é“¾æ¥: /reports/weekly?weekStart=2025-12-15
//    å‘¨æœŸèŒƒå›´: 2025-12-15 è‡³ 2025-12-21
//    æ ‡ç­¾: 12/15 - 12/21
```

**éªŒè¯**ï¼š
- âœ… é‚®ä»¶æ ‡é¢˜æ˜¾ç¤ºï¼š`12/15 - 12/21`
- âœ… æŸ¥çœ‹é“¾æ¥å‚æ•°ï¼š`weekStart=2025-12-15`
- âœ… å‘¨æœŸèŒƒå›´ï¼š`2025-12-15 è‡³ 2025-12-21`

---

### æ­¥éª¤ 4ï¼šæŸ¥çœ‹å‘¨æŠ¥é¡µé¢

1. **ç‚¹å‡»ä¿¡ç®±ä¸­çš„å‘¨æŠ¥é‚®ä»¶**
2. **ç‚¹å‡»"æŸ¥çœ‹å‘¨æŠ¥"æŒ‰é’®**
3. **æŸ¥çœ‹å‘¨æŠ¥é¡µé¢**

**éªŒè¯ç‚¹**ï¼š
- âœ… é¡µé¢æ ‡é¢˜ï¼š`å‘¨æŠ¥ Â· 12/15 - 12/21`
- âœ… 7å¤©æŸ±çŠ¶å›¾ï¼šæ˜¾ç¤º 12/15, 12/16, ..., 12/21
- âœ… æ¯å¤©çš„ä¸“æ³¨æ—¶é•¿å’Œå¿ƒæµæŒ‡æ•°éƒ½æ˜¾ç¤º
- âœ… æœ€ä½³æ—¥å°ç»“æ˜¾ç¤ºæ­£ç¡®æ—¥æœŸ

---

## ğŸ“Š æ•°æ®æµéªŒè¯

### å®Œæ•´æ•°æ®æµ

```
ç”¨æˆ·å®Œæˆä¸“æ³¨ï¼ˆ12/15 - 12/21ï¼‰
  â†“
ä¿å­˜åˆ° FocusSession è¡¨
  â”œâ”€ startTime: 2025-12-15T10:00:00
  â”œâ”€ duration: 60
  â”œâ”€ flowIndex: 75
  â””â”€ rating: 3
  â†“
ä¿å­˜åˆ° DailySummary è¡¨
  â”œâ”€ date: '2025-12-15'
  â”œâ”€ text: 'ä»Šæ—¥å°ç»“'
  â””â”€ totalFocusMinutes: 60
  â†“
å‘¨ä¸€ï¼ˆ12/23ï¼‰ç”Ÿæˆå‘¨æŠ¥
  â†“
æŸ¥è¯¢æ•°æ®åº“
  â”œâ”€ FocusSession (12/15 - 12/21)
  â””â”€ DailySummary (7å¤©)
  â†“
ç”Ÿæˆ daily æ•°ç»„ï¼ˆ7å¤©ï¼‰
  â”œâ”€ 2025-12-15: 60åˆ†é’Ÿ, å¿ƒæµ75 âœ…
  â”œâ”€ 2025-12-16: 45åˆ†é’Ÿ, å¿ƒæµ80 âœ…
  â”œâ”€ 2025-12-17: 30åˆ†é’Ÿ, å¿ƒæµ70 âœ…
  â”œâ”€ 2025-12-18: 0åˆ†é’Ÿ, å¿ƒæµnull
  â”œâ”€ 2025-12-19: 50åˆ†é’Ÿ, å¿ƒæµ85 âœ…
  â”œâ”€ 2025-12-20: 40åˆ†é’Ÿ, å¿ƒæµ78 âœ…
  â””â”€ 2025-12-21: 75åˆ†é’Ÿ, å¿ƒæµ82 âœ…
  â†“
ä¿å­˜åˆ° WeeklyReport è¡¨
  â”œâ”€ weekStart: 2025-12-15
  â”œâ”€ weekEnd: 2025-12-21
  â”œâ”€ payloadJson: { daily: [...], totals: {...} }
  â””â”€ expiresAt: 2025-03-17ï¼ˆ84å¤©åï¼‰
  â†“
åˆ›å»ºé‚®ä»¶å¯¹è±¡
  â”œâ”€ title: 'æœ¬å‘¨ä¸“æ³¨å‘¨æŠ¥ Â· 12/15 - 12/21'
  â”œâ”€ actionUrl: '/reports/weekly?weekStart=2025-12-15'
  â””â”€ date: '2025-12-23'
  â†“
æ·»åŠ åˆ°ä¿¡ç®±ç³»ç»Ÿ
  â””â”€ localStorage.customMails
```

---

## ğŸ¯ å…³é”®ä¿®å¤ç‚¹æ€»ç»“

### 1. æ—¶åŒºå¤„ç† âœ…

| ä½ç½® | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| formatDateKey | toISOString() (UTC) | æ‰‹åŠ¨æ ¼å¼åŒ–ï¼ˆæœ¬åœ°ï¼‰ |
| æ—¥æœŸè®¡ç®— | å¯èƒ½åç§» | ä½¿ç”¨æœ¬åœ°æ—¶åŒº |
| æ—¥å¿—è¾“å‡º | æ—  | è¯¦ç»†çš„æ—¶åŒºä¿¡æ¯ |

### 2. æ•°æ®å­˜å‚¨ âœ…

| é¡¹ç›® | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| DailySummary ä¿ç•™æ•°é‡ | 8 æ¡ | 10 æ¡ |
| å‘¨æŠ¥æŸ¥è¯¢æ•°é‡ | 8 æ¡ | 10 æ¡ |
| æ•°æ®è¦†ç›–èŒƒå›´ | 8 å¤© | 10 å¤© |

### 3. å‘¨æœŸè®¡ç®— âœ…

| é¡¹ç›® | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| å‘¨æ—¥è®¡ç®— | å‘¨ä¸€+7å¤© | å‘¨ä¸€+6å¤© âœ… |
| æ—¶é—´èŒƒå›´ | 00:00 - 00:00 | 00:00 - 23:59 âœ… |
| æ—¥å¿—è¾“å‡º | ç®€å• | è¯¦ç»†å®Œæ•´ âœ… |

### 4. æ—¥æœŸä¸€è‡´æ€§ âœ…

| ä½ç½® | æ—¥æœŸæ¥æº | æ ¼å¼ |
|------|---------|------|
| é‚®ä»¶æ ‡é¢˜ | report.period.label | 12/15 - 12/21 âœ… |
| é‚®ä»¶é“¾æ¥ | weekStart å‚æ•° | 2025-12-15 âœ… |
| å‘¨æŠ¥é¡µé¢æ ‡é¢˜ | report.period.label | 12/15 - 12/21 âœ… |
| å‘¨æŠ¥æŸ±çŠ¶å›¾ | daily[].date | 12/15, 12/16, ... âœ… |

---

## ğŸš€ ç«‹å³éªŒè¯

### å¿«é€ŸéªŒè¯å‘½ä»¤ï¼ˆå¤åˆ¶åˆ°æ§åˆ¶å°ï¼‰

```javascript
// ========== å®Œæ•´éªŒè¯æµç¨‹ ==========

// 1. æ£€æŸ¥æ—¶åŒº
console.log('æ­¥éª¤ 1ï¼šæ£€æŸ¥æ—¶åŒº');
checkTimezone();

// 2. æ£€æŸ¥æ—¥æœŸåŒºé—´
console.log('\næ­¥éª¤ 2ï¼šæ£€æŸ¥æ—¥æœŸåŒºé—´');
checkWeekDates();

// 3. ç”Ÿæˆæµ‹è¯•å‘¨æŠ¥
console.log('\næ­¥éª¤ 3ï¼šç”Ÿæˆæµ‹è¯•å‘¨æŠ¥');
await generateTestWeeklyMail();

// 4. æ£€æŸ¥ä¿¡ç®±æ—¥æœŸ
console.log('\næ­¥éª¤ 4ï¼šæ£€æŸ¥ä¿¡ç®±æ—¥æœŸ');
checkMailboxDates();

// 5. æ‰‹åŠ¨éªŒè¯
console.log('\næ­¥éª¤ 5ï¼šæ‰‹åŠ¨éªŒè¯');
console.log('è¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š');
console.log('1. ç‚¹å‡»ä¿¡ç®±å›¾æ ‡ ğŸ“§');
console.log('2. æŸ¥çœ‹å‘¨æŠ¥é‚®ä»¶æ ‡é¢˜ï¼ˆåº”è¯¥æ˜¯ 12/15 - 12/21ï¼‰');
console.log('3. ç‚¹å‡»é‚®ä»¶ï¼Œç‚¹å‡»"æŸ¥çœ‹å‘¨æŠ¥"');
console.log('4. ç¡®è®¤å‘¨æŠ¥é¡µé¢æ ‡é¢˜ä¹Ÿæ˜¯ 12/15 - 12/21');
console.log('5. ç¡®è®¤7å¤©æŸ±çŠ¶å›¾éƒ½æœ‰æ•°æ®');
```

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒä¿®å¤

1. âœ… `src/lib/weeklyReport.ts`
   - ä¿®å¤ `formatDateKey()` - ä½¿ç”¨æœ¬åœ°æ—¶åŒº
   - ä¼˜åŒ– `getWeekRange()` - æ­£ç¡®è®¡ç®—å‘¨æ—¥
   - å¢åŠ è¯¦ç»†æ—¥å¿—
   - å¢åŠ  DailySummary æŸ¥è¯¢æ•°é‡ï¼ˆ8â†’10ï¼‰

2. âœ… `src/pages/api/daily-summary/today.ts`
   - å¢åŠ  DailySummary ä¿ç•™æ•°é‡ï¼ˆ8â†’10ï¼‰

3. âœ… `src/pages/api/generate-weekly-mail.ts`
   - å¢åŠ è¯¦ç»†æ—¥å¿—
   - æ˜¾ç¤ºå‘¨æœŸèŒƒå›´

### æµ‹è¯•å·¥å…·

4. âœ… `CHECK_TIMEZONE_AND_DATES.js` **ï¼ˆæ–°å»ºï¼‰**
   - æ—¶åŒºæ£€æŸ¥å·¥å…·
   - æ—¥æœŸåŒºé—´éªŒè¯
   - é‚®ç®±æ—¥æœŸæ£€æŸ¥
   - æµ‹è¯•å‘¨æŠ¥ç”Ÿæˆ

---

## ğŸ’¡ å¸¸è§é—®é¢˜

### Q1ï¼šä¸ºä»€ä¹ˆä¸Šå‘¨æ˜¯ 12/15-12/21ï¼Ÿ

**A**ï¼šä»Šå¤©æ˜¯ 2025-12-23ï¼ˆå‘¨äºŒï¼‰

è®¡ç®—é€»è¾‘ï¼š
```
ä»Šå¤©ï¼š2025-12-23ï¼ˆå‘¨äºŒï¼‰
æœ¬å‘¨ä¸€ï¼š2025-12-22ï¼ˆå‘¨ä¸€ï¼‰
ä¸Šå‘¨ä¸€ï¼š2025-12-22 - 7 = 2025-12-15ï¼ˆå‘¨ä¸€ï¼‰âœ…
ä¸Šå‘¨æ—¥ï¼š2025-12-15 + 6 = 2025-12-21ï¼ˆå‘¨æ—¥ï¼‰âœ…
```

### Q2ï¼šå¦‚ä½•ç¡®è®¤æˆ‘çš„æ—¶åŒºï¼Ÿ

**A**ï¼šè¿è¡Œ `checkTimezone()`

è¾“å‡ºä¼šæ˜¾ç¤ºï¼š
- æœ¬åœ°æ—¶é—´
- UTC æ—¶é—´
- æ—¶åŒºåç§»ï¼ˆä¾‹å¦‚ï¼š-480 åˆ†é’Ÿ = UTC+8ï¼‰
- æ—¶åŒºåç§°ï¼ˆä¾‹å¦‚ï¼šAsia/Shanghaiï¼‰

### Q3ï¼š7å¤©æ•°æ®ä¼šä¸ä¼šä¸¢å¤±ï¼Ÿ

**A**ï¼šä¸ä¼šï¼

ä¿®å¤åçš„ä¿æŠ¤æœºåˆ¶ï¼š
- âœ… DailySummary ä¿ç•™ 10 æ¡ï¼ˆå¯è¦†ç›–10å¤©ï¼‰
- âœ… FocusSession æ°¸ä¹…ä¿å­˜ï¼ˆä¸åˆ é™¤ï¼‰
- âœ… å‘¨æŠ¥æŸ¥è¯¢æ—¶ä¼šè·å–å®Œæ•´çš„7å¤©æ•°æ®
- âœ… å³ä½¿æŸå¤©æ²¡æœ‰å°ç»“ï¼Œä¹Ÿä¼šæ˜¾ç¤ºä¸“æ³¨æ—¶é•¿å’Œå¿ƒæµ

### Q4ï¼šå¦‚æœæŸå¤©æ²¡æœ‰ä¸“æ³¨æ€ä¹ˆåŠï¼Ÿ

**A**ï¼šå‘¨æŠ¥ä¼šæ˜¾ç¤º0åˆ†é’Ÿ

```typescript
// æ¯å¤©éƒ½ä¼šç”Ÿæˆæ•°æ®ï¼Œå³ä½¿æ˜¯0
{
  date: '2025-12-18',
  minutes: 0,        // âœ… æ˜¾ç¤º0
  flowIndex: null,   // âœ… æ˜¾ç¤ºä¸º null
  note: null
}
```

åœ¨å‘¨æŠ¥é¡µé¢ä¸Šä¼šæ˜¾ç¤ºä¸ºå¾ˆçŸ­çš„æŸ±å­ã€‚

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šå‘¨æŠ¥æ—¥æœŸä¸å¯¹

**æ£€æŸ¥æ­¥éª¤**ï¼š

1. **è¿è¡Œæ—¶åŒºæ£€æŸ¥**ï¼š
```javascript
checkTimezone();
// ç¡®è®¤æ—¶åŒºæ˜¯å¦æ­£ç¡®
```

2. **è¿è¡Œæ—¥æœŸæ£€æŸ¥**ï¼š
```javascript
checkWeekDates();
// ç¡®è®¤ä¸Šå‘¨çš„æ—¥æœŸåŒºé—´
```

3. **æŸ¥çœ‹ API æ—¥å¿—**ï¼š
   - ç”Ÿæˆå‘¨æŠ¥æ—¶æŸ¥çœ‹æ§åˆ¶å°
   - æŸ¥æ‰¾ `[getWeekRange]` å’Œ `[computeWeeklyReport]` æ—¥å¿—
   - ç¡®è®¤æ—¥æœŸè®¡ç®—æ­£ç¡®

### é—®é¢˜ï¼š7å¤©æ•°æ®ä¸å®Œæ•´

**æ£€æŸ¥æ­¥éª¤**ï¼š

1. **æŸ¥çœ‹æ•°æ®åº“**ï¼š
```javascript
// åœ¨æ§åˆ¶å°è¿è¡Œ
fetch('/api/focus-sessions?limit=100')
  .then(res => res.json())
  .then(data => {
    console.log('æ€»ä¸“æ³¨è®°å½•:', data.total);
    console.log('æœ€è¿‘è®°å½•:', data.sessions.slice(0, 10));
    
    // æŒ‰æ—¥æœŸåˆ†ç»„
    const byDate = {};
    data.sessions.forEach(s => {
      const date = s.startTime.split('T')[0];
      byDate[date] = (byDate[date] || 0) + 1;
    });
    console.log('æŒ‰æ—¥æœŸåˆ†ç»„:', byDate);
  });
```

2. **æŸ¥çœ‹å‘¨æŠ¥æ—¥å¿—**ï¼š
   - ç”Ÿæˆå‘¨æŠ¥æ—¶æŸ¥çœ‹ `[computeWeeklyReport]` æ—¥å¿—
   - ç¡®è®¤æ¯å¤©çš„æ•°æ®éƒ½æœ‰è®°å½•

---

## ğŸ“Š é¢„æœŸè¾“å‡º

### æ­£ç¡®çš„å‘¨æŠ¥æ•°æ®

```json
{
  "period": {
    "start": "2025-12-15T00:00:00.000Z",
    "end": "2025-12-21T23:59:59.999Z",
    "label": "12/15 - 12/21"
  },
  "daily": [
    { "date": "2025-12-15", "minutes": 60, "flowIndex": 75, "note": "..." },
    { "date": "2025-12-16", "minutes": 45, "flowIndex": 80, "note": "..." },
    { "date": "2025-12-17", "minutes": 30, "flowIndex": 70, "note": "..." },
    { "date": "2025-12-18", "minutes": 0, "flowIndex": null, "note": null },
    { "date": "2025-12-19", "minutes": 50, "flowIndex": 85, "note": "..." },
    { "date": "2025-12-20", "minutes": 40, "flowIndex": 78, "note": "..." },
    { "date": "2025-12-21", "minutes": 75, "flowIndex": 82, "note": "..." }
  ],
  "totals": {
    "minutes": 300,
    "streakDays": 6,
    "flowAvg": 78
  }
}
```

### æ­£ç¡®çš„é‚®ä»¶å¯¹è±¡

```json
{
  "id": "weekly_report_2025-12-15",
  "sender": "Echo å‘¨æŠ¥",
  "title": "æœ¬å‘¨ä¸“æ³¨å‘¨æŠ¥ Â· 12/15 - 12/21",
  "content": "æ‚¨çš„æœ¬å‘¨ä¸“æ³¨å‘¨æŠ¥å·²ç”Ÿæˆ~ ...",
  "date": "2025-12-23",
  "type": "report",
  "actionUrl": "/reports/weekly?weekStart=2025-12-15",
  "actionLabel": "æŸ¥çœ‹å‘¨æŠ¥"
}
```

---

## âœ… ä¿®å¤æ€»ç»“

### å·²ä¿®å¤

1. **æ—¶åŒºå¤„ç†** âœ…
   - ä½¿ç”¨ç”¨æˆ·æœ¬åœ°æ—¶åŒº
   - ä¿®å¤ `formatDateKey()` å‡½æ•°
   - æ—¥æœŸä¸å†åç§»

2. **æ•°æ®å­˜å‚¨** âœ…
   - DailySummary ä¿ç•™ 10 æ¡
   - ç¡®ä¿ä¸Šå‘¨æ•°æ®å®Œæ•´
   - 7å¤©æ•°æ®éƒ½èƒ½æ­£ç¡®æ˜¾ç¤º

3. **å‘¨æœŸè®¡ç®—** âœ…
   - å‘¨æ—¥ = å‘¨ä¸€ + 6 å¤©
   - æ—¶é—´èŒƒå›´ï¼š00:00 - 23:59
   - è¯¦ç»†çš„è®¡ç®—æ—¥å¿—

4. **æ—¥æœŸä¸€è‡´æ€§** âœ…
   - é‚®ç®±æ ‡é¢˜ï¼š12/15 - 12/21
   - é‚®ä»¶é“¾æ¥ï¼šweekStart=2025-12-15
   - å‘¨æŠ¥é¡µé¢ï¼š12/15 - 12/21
   - 7å¤©æŸ±çŠ¶å›¾ï¼š12/15, 12/16, ..., 12/21

### æ•ˆæœ

- âœ… å‘¨æŠ¥æ˜¾ç¤ºæ­£ç¡®çš„æ—¥æœŸåŒºé—´
- âœ… 7å¤©æ•°æ®å®Œæ•´ä¿å­˜å’Œæ˜¾ç¤º
- âœ… ä¸“æ³¨æ—¶é•¿å’Œå¿ƒæµæŒ‡æ•°éƒ½æ­£ç¡®
- âœ… é‚®ç®±å’Œå‘¨æŠ¥é¡µé¢æ—¥æœŸä¸€è‡´
- âœ… è¯¦ç»†çš„æ—¥å¿—æ–¹ä¾¿è°ƒè¯•

---

**ä¿®å¤æ—¥æœŸ**ï¼š2025-12-23  
**ä¿®å¤ç‰ˆæœ¬**ï¼šv3.1.0  
**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

**ä¸‹ä¸€æ­¥**ï¼š
1. è¿è¡Œ `CHECK_TIMEZONE_AND_DATES.js` éªŒè¯
2. ç”Ÿæˆæµ‹è¯•å‘¨æŠ¥
3. ç¡®è®¤æ—¥æœŸåŒºé—´æ­£ç¡®ï¼ˆ12/15-12/21ï¼‰

æœ‰ä»»ä½•é—®é¢˜éšæ—¶å‘Šè¯‰æˆ‘ï¼ğŸš€



